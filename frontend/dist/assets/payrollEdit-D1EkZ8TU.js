import{aU as Re,r as n,g as Ye,h as v,j as e,T as b,F as W,I as U,S as H,M as z,A as _e,k as We,b as x,a5 as le,ak as ne,B as J,c as ye,y as re}from"./index-DPcpnn9F.js";import{b as oe}from"./index-CmfoG6p7.js";import{i as Ue}from"./isSameOrBefore-u7UyVsbe.js";import{i as He}from"./isBetween-BtwPy2i1.js";import{l as Je}from"./localeData-B5dqAAVA.js";import{n as qe}from"./numToWord-bs75z5E6.js";import{C,D}from"./Divider-CesY12Pu.js";import{F as P}from"./FormControlLabel-BQSUSkO-.js";import{C as F}from"./Checkbox-COXqBuDP.js";import"./SwitchBase-BItRdG1X.js";v.extend(Je);v.extend(He);v.extend(Ue);function na(){const{id:q}=Re(),[G,be]=n.useState([]),[M,De]=n.useState(""),[c,de]=n.useState(null),[B,ge]=n.useState(0),[g,we]=n.useState(0),[Ne,Ae]=n.useState([]),[K,Ge]=n.useState(0),[h,Se]=n.useState(null),[N,ke]=n.useState(0),[A,Ce]=n.useState(0),{holidays:S,company:u,employee:O,attandence:Q,leaveBalance:V,advance:X}=Ye(s=>s.user),[ie,T]=n.useState(!1),[ce,me]=n.useState(null),[ue,E]=n.useState(null),Me={addOvertime:!1,deductShortTime:!1,deductAbsent:!1,adjustLeave:!1,adjustAdvance:!1,adjustedLeaveCount:0,adjustedAdvance:0},[d,y]=n.useState(Me);n.useEffect(()=>{},[d]);function p(s){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(s)}n.useEffect(()=>{(async()=>{var a,t,r;try{T(!0),E(null);const o=localStorage.getItem("emstoken"),f=await ye.get(`/api/payroll/${q}`,{headers:{Authorization:`Bearer ${o}`}});Se((a=f==null?void 0:f.data)==null?void 0:a.payroll)}catch(o){console.error(o),E(((r=(t=o.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to fetch payroll"),re.warn("Using dummy payroll data for testing",{autoClose:1500})}finally{T(!1)}})()},[q]),n.useEffect(()=>{var a;if(!c||!V)return;const s=(a=V.filter(t=>{var r,o,f;return((o=(r=t.employeeId)==null?void 0:r._id)==null?void 0:o.toString())===((f=c._id)==null?void 0:f.toString())}).slice().sort((t,r)=>new Date(r.date)-new Date(t.date)))==null?void 0:a[0];ke((s==null?void 0:s.balance)+(d==null?void 0:d.adjustedLeaveCount))},[V,c]),n.useEffect(()=>{var a;if(!c||!X)return;const s=(a=X.filter(t=>{var r,o,f;return((o=(r=t.employeeId)==null?void 0:r._id)==null?void 0:o.toString())===((f=c._id)==null?void 0:f.toString())}).slice().sort((t,r)=>new Date(r.date)-new Date(t.date)))==null?void 0:a[0];Ce((s==null?void 0:s.balance)+(d==null?void 0:d.adjustedAdvance))},[X,c]),n.useEffect(()=>{h&&(k({month:h.month,year:h.year,calculationBasis:"monthDays",allowances:h.allowances,bonuses:h.bonuses,deductions:h.deductions,leaveDays:h.leave,absentDays:h.absent,presentDays:h.present,paidDays:0,adjustPaidLeave:!1}),y(h==null?void 0:h.options),de(O==null?void 0:O.filter(s=>s._id==h.employeeId)[0]),De(h.employeeId))},[h]);const[l,k]=n.useState({month:new Date().getMonth()+1,year:new Date().getFullYear(),calculationBasis:"monthDays",allowances:[{name:"HRA",amount:0,extraInfo:"",inputDisabled:!1}],bonuses:[{name:"Performance",amount:0,extraInfo:"",inputDisabled:!1}],deductions:[{name:"PF",amount:0,extraInfo:"",inputDisabled:!1}],leaveDays:0,absentDays:0,presentDays:0,paidDays:0,adjustPaidLeave:!1}),[i,Ie]=n.useState({totalDays:0,holidaysCount:0,weeklyOff:0,workingDays:0,overtime:0,shortmin:0}),Be=["January","February","March","April","May","June","July","August","September","October","November","December"];n.useEffect(()=>{be(O||[])},[O]),n.useEffect(()=>{if(!c||!(i!=null&&i.totalDays)||!(u!=null&&u.workingMinutes))return;let s=l.calculationBasis==="monthDays"?i.totalDays||1:i.totalDays-(i.holidaysCount+i.weeklyOff)||1;const a=c.salary/s,t=a/u.workingMinutes.fullDay;ge(t.toFixed(2)),we(a.toFixed(2))},[l.calculationBasis,i,c,u,h]),n.useEffect(()=>{if(!S)return;const s=[];S.forEach(a=>{let t=v(a.fromDate);const r=a.toDate?v(a.toDate):t;for(;t.isSameOrBefore(r,"day");)s.push(t.format("DD/MM/YYYY")),t=t.add(1,"day")}),Ae(s)},[S]),n.useEffect(()=>{var ve;if(!Q||!M)return;const s=G.find(m=>m._id===M);de(s);const a=v(`${l.year}-${String(l.month).padStart(2,"0")}-01`),t=a.isSame(v(),"month"),o=a.endOf("month").date(),f=Q.filter(m=>m.employeeId._id===M&&v(m.date).isSame(a,"month")),{present:fe,absent:ze,leaves:Pe,overtime:Fe,shortmin:Te}=f.reduce((m,j)=>{var pe,je;j.status==="present"&&m.present++,j.status==="absent"&&m.absent++,j.status==="leave"&&m.leaves++;const te=v(j.date).format("DD/MM/YYYY"),{workingMinutes:w}=j,_=v(j.date).startOf("day").day(),Ee=Ne.includes(te),$e=u==null?void 0:u.weeklyOffs.includes(_);return Ee||$e?m.overtime+=w:j.status==="present"&&(w<((pe=u==null?void 0:u.workingMinutes)==null?void 0:pe.shortDayThreshold)?m.shortmin+=u.workingMinutes.shortDayThreshold-w:w>((je=u==null?void 0:u.workingMinutes)==null?void 0:je.overtimeAfterMinutes)&&(m.overtime+=w-u.workingMinutes.overtimeAfterMinutes)),m},{present:0,absent:0,leaves:0,overtime:0,shortmin:0});k(m=>({...m,leaveDays:Pe,absentDays:ze,presentDays:fe,paidDays:fe}));let ae=0;for(let m=1;m<=o;m++){const j=a.date(m);(ve=u==null?void 0:u.weeklyOffs)!=null&&ve.includes(j.day())&&ae++}let se=0;S==null||S.forEach(m=>{const j=v(m.fromDate),te=v(m.toDate);for(let w=1;w<=o;w++){const _=a.date(w);if(t&&_.isAfter(v(),"day"))break;_.isBetween(j,te,"day","[]")&&se++}}),Ie({totalDays:o,workingDays:o-(ae+se),weeklyOff:ae,holidaysCount:se,overtime:Fe,shortmin:Te})},[M,Q,l.month,l.year,G,u,S]);const xe=n.useMemo(()=>l.adjustPaidLeave?Math.max(l.leaveDays-N,0):l.leaveDays,[l.leaveDays,l.adjustPaidLeave,N]),Oe=n.useMemo(()=>xe*g,[xe,g]),$=n.useMemo(()=>l.allowances.reduce((s,a)=>s+Number(a.amount),0),[l.allowances]),R=n.useMemo(()=>l.bonuses.reduce((s,a)=>s+Number(a.amount),0),[l.bonuses]),Y=n.useMemo(()=>l.deductions.reduce((s,a)=>s+Number(a.amount),0),[l.deductions,Oe]),L=n.useMemo(()=>(c==null?void 0:c.salary)+$+R,[g,l.paidDays,$,R]);n.useMemo(()=>(L*K/100).toFixed(2),[L,K]);const he=n.useMemo(()=>Math.floor(L-Y),[L,Y]);n.useCallback(s=>{const a=Math.floor(s/60),t=s%60;return`${a}h ${t}m`},[]);const I=(s,a,t,r)=>{const o=[...l[s]];o[a][t]=r,k(f=>({...f,[s]:o}))};n.useEffect(()=>{let s=[...l.bonuses],a=[...l.deductions];if(s=s.filter(t=>t.name!=="Overtime"),d.addOvertime){const t=i.overtime*B;s.push({name:"Overtime",amount:t.toFixed(2),extraInfo:`${i.overtime} Min @ ₹${B} per min.`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Short Time"),d.deductShortTime&&i.shortmin>0){const t=i.shortmin*B;a.push({name:"Short Time",amount:t.toFixed(2),extraInfo:`${i.shortmin} min @ ₹${B} per min.`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Absent"),d.deductAbsent&&l.absentDays>0&&a.push({name:"Absent",amount:(l.absentDays*g).toFixed(2),extraInfo:`${l.absentDays} Absent @ ₹${g} per day`,inputDisabled:!0}),a=a.filter(t=>t.name!=="Advance"),d.adjustAdvance&&A>0){let t=A-d.adjustedAdvance;a.push({name:"Advance",amount:d.adjustedAdvance.toFixed(2),extraInfo:`Adjusted :${d.adjustedAdvance},  Remaining :${t}`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Paid Leave Adjustment"&&t.name!=="Unpaid Leave"),d.adjustLeave&&l.leaveDays>0){const t=Math.min(d.adjustedLeaveCount,N,l.leaveDays),r=l.leaveDays-t;t>0&&a.push({name:"Paid Leave Adjustment",amount:0,extraInfo:`${t} Leaves adjusted, Remaining Leaves: ${N-t}`,inputDisabled:!0}),r>0&&a.push({name:"Unpaid Leave",amount:(r*g).toFixed(2),extraInfo:`${r} leaves @ ${g}`,inputDisabled:!0})}k(t=>({...t,bonuses:s,deductions:a}))},[d,g,l.leaveDays,l.absentDays,i.shortmin]);const Z=(s,a)=>k(t=>({...t,[s]:[...t[s],a]})),ee=(s,a)=>k(t=>{const r=[...t[s]];return r.splice(a,1),{...t,[s]:r}}),Le=async()=>{var a,t,r;const s={employeeId:c._id,calculationBasis:l.calculationBasis,options:d,basic:i,month:l.month,year:l.year,present:l.presentDays,leave:l.leaveDays,absent:l.absentDays,allowances:l.allowances,bonuses:l.bonuses,deductions:l.deductions,taxRate:K,name:(a=c==null?void 0:c.userid)==null?void 0:a.name};try{T(!0),E(null),me(null);const o=localStorage.getItem("emstoken"),f=await ye.put(`/api/payroll/${q}`,{...s},{headers:{Authorization:`Bearer ${o}`}});console.log(f),re.success(f.data.message),me("Payroll updated successfully!")}catch(o){console.log(o),o.response?(E(((r=(t=o.response)==null?void 0:t.data)==null?void 0:r.message)||"Failed to create payroll"),re.warn(o.response.data.message,{autoClose:1200})):o.request?console.error("No response from server:",o.request):console.error("Error:",o.message)}finally{T(!1)}};return e.jsxs("div",{className:"max-w-full gap-4 grid grid-cols-2 mx-auto p-0 md:p-6 space-y-1",children:[e.jsxs(C,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Select Employee"}),e.jsx(D,{}),e.jsxs("div",{className:"grid gap-2 md:gap-4 grid-cols-2 mt-4 space-y-1",children:[e.jsxs(W,{size:"small",children:[e.jsx(U,{children:"Month"}),e.jsx(H,{label:"Month",disabled:!0,value:l.month,children:Be.map((s,a)=>e.jsx(z,{value:a+1,children:s},a))})]}),e.jsxs(W,{size:"small",children:[e.jsx(U,{children:"Year"}),e.jsx(H,{label:"year",disabled:!0,value:l.year,children:["2024","2025","2026"].map(s=>e.jsx(z,{value:s,children:s},s))})]}),e.jsxs(W,{size:"small",children:[e.jsx(U,{children:"Calc. Basis"}),e.jsxs(H,{label:"Calc. Basis",value:l.calculationBasis,onChange:s=>k(a=>({...a,calculationBasis:s.target.value})),children:[e.jsx(z,{value:"monthDays",children:"Month Days"}),e.jsx(z,{value:"workingDays",children:"Working Days"})]})]}),e.jsxs(W,{disabled:!l.month||!l.year,className:"col-span-1",size:"small",children:[e.jsx(U,{children:"Select Employee"}),e.jsx(H,{label:"Select Employee",value:M,disabled:!0,children:G.map(s=>{var a;return e.jsx(z,{value:s._id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{src:We(s.profileimage,{format:"webp",width:100,height:100}),sx:{width:24,height:24}}),(a=s.userid)==null?void 0:a.name]})},s._id)})})]})]})]}),c&&e.jsxs(C,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Attendance Summary"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col  gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Total Days",value:i.totalDays}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Holidays",value:i.holidaysCount}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Weekly Offs",value:i.weeklyOff}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Working Days",value:i.workingDays}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Present Days",value:l.presentDays||0}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Leave Days",value:l.leaveDays||0}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Absent Days",value:l.absentDays||0})]}),e.jsx(D,{}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(x,{size:"small",label:"OverTime Minutes",value:i.overtime||0}),e.jsx(x,{size:"small",label:"ShortTime Minutes",value:i.shortmin||0}),e.jsx(x,{size:"small",label:"Per day Salary",value:p(g),helperText:"For Leave/ Absent Calculations"}),e.jsx(x,{size:"small",label:"Per minute Salary",value:p(B),helperText:"For OverTime/ ShortTime Calculations"})]})]})]}),c&&e.jsxs(C,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Adjustments"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col gap-2 mt-4",children:[i!=null&&i.overtime?e.jsx(P,{className:" w-fit",control:e.jsx(F,{checked:d.addOvertime,onChange:s=>y(a=>({...a,addOvertime:s.target.checked}))}),label:"Add Overtime as Bonus"}):"",i!=null&&i.shortmin?e.jsx(P,{className:" w-fit",control:e.jsx(F,{checked:d.deductShortTime,onChange:s=>y(a=>({...a,deductShortTime:s.target.checked}))}),label:"Deduct Short Time"}):"",l!=null&&l.absentDays?e.jsx(P,{className:" w-fit",control:e.jsx(F,{checked:d.deductAbsent,onChange:s=>y(a=>({...a,deductAbsent:s.target.checked}))}),label:"Deduct Absent Days"}):"",l!=null&&l.leaveDays?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(P,{control:e.jsx(F,{checked:d.adjustLeave,onChange:s=>y(a=>({...a,adjustLeave:s.target.checked}))}),label:"Adjust Paid Leaves"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Available Paid leaves: ",N]}),d.adjustLeave&&e.jsx(x,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Count",inputProps:{min:0,max:Math.min(N,l.leaveDays)},value:d.adjustedLeaveCount,onChange:s=>{const a=Number(s.target.value),t=Math.min(N,l.leaveDays);y(r=>({...r,adjustedLeaveCount:Math.max(0,Math.min(a,t))}))}})]}):"",A>0?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(P,{control:e.jsx(F,{checked:d.adjustAdvance,onChange:s=>y(a=>({...a,adjustAdvance:s.target.checked}))}),label:"Adjust Advance"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Advance: ",A]}),d.adjustAdvance&&e.jsx(x,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Advance",inputProps:{min:0,max:A},value:d.adjustedAdvance,onChange:s=>{const a=Number(s.target.value);a<0?y(t=>({...t,adjustedAdvance:0})):a>A?y(t=>({...t,adjustedAdvance:A})):y(t=>({...t,adjustedAdvance:a}))}})]}):""]})]}),c&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Allowances"}),e.jsx(b,{variant:"h6",children:p($)})]}),e.jsx(D,{}),l.allowances.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Name",className:"flex-5",value:s.name,onChange:t=>I("allowances",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",label:"Amount",InputProps:{readOnly:s.inputDisabled||!1},className:"flex-2",value:s.amount,onChange:t=>I("allowances",a,"amount",t.target.value)}),e.jsx(le,{onClick:()=>ee("allowances",a),children:e.jsx(ne,{})})]},a)),e.jsx(J,{startIcon:e.jsx(oe,{}),variant:"outlined",onClick:()=>Z("allowances",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2 flex-1",children:"Add Allowance"})]}),c&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Bonuses"}),e.jsx(b,{variant:"h6",children:p(R)})]}),e.jsx(D,{}),l.bonuses.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Name",className:"flex-5",value:s.name,helperText:s.extraInfo??"",onChange:t=>I("bonuses",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",label:"Amount",InputProps:{readOnly:s.inputDisabled||!1},className:"flex-2",value:s.amount,onChange:t=>I("bonuses",a,"amount",t.target.value)}),e.jsx(le,{className:"flex-1",onClick:()=>ee("bonuses",a),children:e.jsx(ne,{})})]},a)),e.jsx(J,{variant:"outlined",startIcon:e.jsx(oe,{}),onClick:()=>Z("bonuses",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Bonus"})]}),c&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Deductions"}),e.jsx(b,{variant:"h6",children:p(Y)})]}),e.jsx(D,{}),l.deductions.map((s,a)=>e.jsxs("div",{className:"flex gap-2  items-start mt-4",children:[e.jsx(x,{size:"small",label:"Deduction",className:"flex-5",value:s.name,helperText:s.extraInfo??"",onChange:t=>I("deductions",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",className:"flex-2",label:"Amount",InputProps:{readOnly:s.inputDisabled||!1},value:s.amount,onChange:t=>I("deductions",a,"amount",t.target.value)}),e.jsx(le,{className:"flex-1",onClick:()=>ee("deductions",a),children:e.jsx(ne,{})})]},a)),e.jsx(J,{variant:"outlined",startIcon:e.jsx(oe,{}),onClick:()=>Z("deductions",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Deduction"})]}),c&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Salary Summary"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col gap-2 text-right mt-3",children:[e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Base Salary :"}),e.jsx("div",{className:"w-[100px] font-semibold",children:p((c==null?void 0:c.salary)||0)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Allowances :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",p($)]})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Bonuses :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",p(R)]})]}),e.jsx(D,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:"Gross Salary :"}),e.jsx("div",{className:"w-[100px]",children:p(L)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Deductions :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["-",p(Y)," "]})]}),e.jsx(D,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:" Net Salary "}),e.jsx("div",{className:"w-[100px]",children:p(he)})]}),e.jsxs("div",{className:"capitalize text-xs",children:[" In Words:- ",qe(he)," "]})]})]}),c&&e.jsx("div",{className:"col-span-2",children:e.jsx(J,{variant:"contained",color:"primary",onClick:Le,disabled:ie||!M,children:ie?"Saving...":"Save Payroll"})}),ce&&e.jsx("p",{className:"text-green-600 mt-2",children:ce}),ue&&e.jsx("p",{className:"text-red-600 mt-2",children:ue})]})}export{na as default};
