import{aT as Fe,r as n,g as Ee,h as f,j as e,T as b,F as Y,I as _,S as W,M as P,A as $e,b as x,X as ae,al as se,B as J,c as Re,y as pe}from"./index-IHelaw-x.js";import{b as te}from"./index-CZNv2t76.js";import{i as Ye}from"./isSameOrBefore-A4IAwUpM.js";import{i as _e}from"./isBetween-CUbXqfnL.js";import{l as We}from"./localeData-B35dIJ-N.js";import{n as Je}from"./numToWord-bs75z5E6.js";import{C as k,D}from"./Divider-CodKPsbG.js";import{F as z}from"./FormControlLabel-305zdSzv.js";import{C as L}from"./Checkbox-BksB3pid.js";f.extend(We);f.extend(_e);f.extend(Ye);function aa(){const{employeeId:je}=Fe(),[q,ye]=n.useState([]),[M,be]=n.useState(je||""),[i,De]=n.useState(null),[O,ge]=n.useState(0),[g,we]=n.useState(0),[Ne,Ae]=n.useState([]),[H,qe]=n.useState(0),[A,Se]=n.useState(0),[S,Ce]=n.useState(0),{holidays:C,company:d,employee:le,attandence:U,leaveBalance:G,advance:X}=Ee(s=>s.user),[ne,oe]=n.useState(!1),[re,ie]=n.useState(null),[de,ce]=n.useState(null);n.useEffect(()=>{var a;if(!i||!G)return;const s=(a=G.filter(t=>{var o,c,h;return((c=(o=t.employeeId)==null?void 0:o._id)==null?void 0:c.toString())===((h=i._id)==null?void 0:h.toString())}).slice().sort((t,o)=>new Date(o.date)-new Date(t.date)))==null?void 0:a[0];Se((s==null?void 0:s.balance)||0)},[G,i]),n.useEffect(()=>{var a;if(!i||!X)return;const s=(a=X.filter(t=>{var o,c,h;return((c=(o=t.employeeId)==null?void 0:o._id)==null?void 0:c.toString())===((h=i._id)==null?void 0:h.toString())}).slice().sort((t,o)=>new Date(o.date)-new Date(t.date)))==null?void 0:a[0];Ce(s==null?void 0:s.balance)},[X,i]);function v(s){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(s)}const[l,w]=n.useState({month:new Date().getMonth()+1,year:new Date().getFullYear(),calculationBasis:"monthDays",allowances:[],bonuses:[],deductions:[],leaveDays:0,absentDays:0,presentDays:0,paidDays:0,adjustPaidLeave:!1}),[r,ke]=n.useState({totalDays:0,holidaysCount:0,weeklyOff:0,workingDays:0,overtime:0,shortmin:0}),me={addOvertime:!1,deductShortTime:!1,deductAbsent:!1,adjustLeave:!1,adjustAdvance:!1,adjustedLeaveCount:0,adjustedAdvance:0},[u,y]=n.useState(me),Me=["January","February","March","April","May","June","July","August","September","October","November","December"];n.useEffect(()=>{ye(le||[])},[le]),n.useEffect(()=>{var s,a,t,o,c,h;!d.payrollPolicies||d.payrollPolicies==""||w({...l,allowances:(a=(s=d.payrollPolicies)==null?void 0:s.allowances)==null?void 0:a.map((p,$)=>({name:p.name,amount:p.value,extraInfo:"",inputDisabled:!1})),bonuses:(o=(t=d.payrollPolicies)==null?void 0:t.bonuses)==null?void 0:o.map((p,$)=>({name:p.name,amount:p.value,extraInfo:"",inputDisabled:!1})),deductions:(h=(c=d.payrollPolicies)==null?void 0:c.deductions)==null?void 0:h.map((p,$)=>({name:p.name,amount:p.value,extraInfo:"",inputDisabled:!1}))})},[d.payrollPolicies]),n.useEffect(()=>{if(!i||!(r!=null&&r.totalDays)||!(d!=null&&d.workingMinutes))return;let s=l.calculationBasis==="monthDays"?r.totalDays||1:r.totalDays-(r.holidaysCount+r.weeklyOff)||1;const a=i.salary/s,t=a/d.workingMinutes.fullDay;ge(t.toFixed(2)),we(a.toFixed(2))},[l.calculationBasis,r,i,d]),n.useEffect(()=>{if(!C)return;const s=[];C.forEach(a=>{let t=f(a.fromDate);const o=a.toDate?f(a.toDate):t;for(;t.isSameOrBefore(o,"day");)s.push(t.format("DD/MM/YYYY")),t=t.add(1,"day")}),Ae(s)},[C]),n.useEffect(()=>{var he;if(!U||!M)return;const s=q.find(m=>m._id===M);y(me),De(s);const a=f(`${l.year}-${String(l.month).padStart(2,"0")}-01`),t=a.isSame(f(),"month"),c=a.endOf("month").date(),h=U.filter(m=>m.employeeId._id===M&&f(m.date).isSame(a,"month")),{present:p,absent:$,leaves:Be,overtime:Pe,shortmin:ze}=h.reduce((m,j)=>{var fe,ve;j.status==="present"&&m.present++,j.status==="absent"&&m.absent++,j.status==="leave"&&m.leaves++;const ee=f(j.date).format("DD/MM/YYYY"),{workingMinutes:N}=j,R=f(j.date).startOf("day").day(),Le=Ne.includes(ee),Te=d==null?void 0:d.weeklyOffs.includes(R);return Le||Te?m.overtime+=N:j.status==="present"&&(N<((fe=d==null?void 0:d.workingMinutes)==null?void 0:fe.shortDayThreshold)?m.shortmin+=d.workingMinutes.shortDayThreshold-N:N>((ve=d==null?void 0:d.workingMinutes)==null?void 0:ve.overtimeAfterMinutes)&&(m.overtime+=N-d.workingMinutes.overtimeAfterMinutes)),m},{present:0,absent:0,leaves:0,overtime:0,shortmin:0});w(m=>({...m,leaveDays:Be,absentDays:$,presentDays:p,paidDays:p}));let V=0;for(let m=1;m<=c;m++){const j=a.date(m);(he=d==null?void 0:d.weeklyOffs)!=null&&he.includes(j.day())&&V++}let Z=0;C==null||C.forEach(m=>{const j=f(m.fromDate),ee=f(m.toDate);for(let N=1;N<=c;N++){const R=a.date(N);if(t&&R.isAfter(f(),"day"))break;R.isBetween(j,ee,"day","[]")&&Z++}}),ke({totalDays:c,workingDays:c-(V+Z),weeklyOff:V,holidaysCount:Z,overtime:Pe,shortmin:ze})},[M,U,l.month,l.year,q,d,C]);const ue=n.useMemo(()=>l.adjustPaidLeave?Math.max(l.leaveDays-A,0):l.leaveDays,[l.leaveDays,l.adjustPaidLeave,A]),Ie=n.useMemo(()=>ue*g,[ue,g]),T=n.useMemo(()=>l.allowances.reduce((s,a)=>s+Number(a.amount),0),[l.allowances]),F=n.useMemo(()=>l.bonuses.reduce((s,a)=>s+Number(a.amount),0),[l.bonuses]),E=n.useMemo(()=>l.deductions.reduce((s,a)=>s+Number(a.amount),0),[l.deductions,Ie]),B=n.useMemo(()=>(i==null?void 0:i.salary)+T+F,[g,l.paidDays,T,F]);n.useMemo(()=>(B*H/100).toFixed(2),[B,H]),n.useCallback(s=>{const a=Math.floor(s/60),t=s%60;return`${a}h ${t}m`},[]);const xe=n.useMemo(()=>Math.floor(B-E),[B,E]),I=(s,a,t,o)=>{const c=[...l[s]];c[a][t]=o,w(h=>({...h,[s]:c}))};n.useEffect(()=>{let s=[...l.bonuses],a=[...l.deductions];if(s=s.filter(t=>t.name!=="Overtime"),u.addOvertime){const t=r.overtime*O;s.push({name:"Overtime",amount:t.toFixed(2),extraInfo:`${r.overtime} Min @ ₹${O} per min.`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Short Time"),u.deductShortTime&&r.shortmin>0){const t=r.shortmin*O;a.push({name:"Short Time",amount:t.toFixed(2),extraInfo:`${r.shortmin} min @ ₹${O} per min.`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Absent"),u.deductAbsent&&l.absentDays>0&&a.push({name:"Absent",amount:(l.absentDays*g).toFixed(2),extraInfo:`${l.absentDays} Absent @ ₹${g} per day`,inputDisabled:!0}),a=a.filter(t=>t.name!=="Advance"),u.adjustAdvance&&S>0){let t=S-u.adjustedAdvance;a.push({name:"Advance",amount:u.adjustedAdvance.toFixed(2),extraInfo:`Adjusted :${u.adjustedAdvance},  Remaining :${t}`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Paid Leave Adjustment"&&t.name!=="Unpaid Leave"),u.adjustLeave&&l.leaveDays>0){const t=Math.min(u.adjustedLeaveCount,A,l.leaveDays),o=l.leaveDays-t;t>0&&a.push({name:"Paid Leave Adjustment",amount:0,extraInfo:`${t} Leaves adjusted, Remaining Leaves: ${A-t}`,inputDisabled:!0}),o>0&&a.push({name:"Unpaid Leave",amount:(o*g).toFixed(2),extraInfo:`${o} leaves @ ${g}`,inputDisabled:!0})}w(t=>({...t,bonuses:s,deductions:a}))},[u,g,l.leaveDays,l.absentDays,r.shortmin]);const K=(s,a)=>w(t=>({...t,[s]:[...t[s],a]})),Q=(s,a)=>w(t=>{const o=[...t[s]];return o.splice(a,1),{...t,[s]:o}}),Oe=async()=>{var a,t,o;const s={employeeId:i._id,calculationBasis:l.calculationBasis,options:u,basic:r,month:l.month,year:l.year,present:l.presentDays,leave:l.leaveDays,absent:l.absentDays,allowances:l.allowances,bonuses:l.bonuses,deductions:l.deductions,taxRate:H,name:(a=i==null?void 0:i.userid)==null?void 0:a.name};try{oe(!0),ce(null),ie(null);const c=localStorage.getItem("emstoken"),h=await Re.post("/api/payroll",{...s},{headers:{Authorization:`Bearer ${c}`}});console.log(h),pe.success(h.data.message),ie("Payroll created successfully!")}catch(c){console.log(c),c.response?(ce(((o=(t=c.response)==null?void 0:t.data)==null?void 0:o.message)||"Failed to create payroll"),pe.warn(c.response.data.message,{autoClose:1200})):c.request?console.error("No response from server:",c.request):console.error("Error:",c.message)}finally{oe(!1)}};return e.jsxs("div",{className:"max-w-full gap-4 grid grid-cols-2 mx-auto p-0 md:p-6 space-y-1",children:[e.jsxs(k,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Select Employee"}),e.jsx(D,{}),e.jsxs("div",{className:"grid gap-2 md:gap-4 grid-cols-2 mt-4 space-y-1",children:[e.jsxs(Y,{size:"small",children:[e.jsx(_,{children:"Month"}),e.jsx(W,{label:"Month",value:l.month,onChange:s=>w(a=>({...a,month:s.target.value})),children:Me.map((s,a)=>e.jsx(P,{value:a+1,children:s},a))})]}),e.jsxs(Y,{size:"small",children:[e.jsx(_,{children:"Year"}),e.jsx(W,{label:"year",value:l.year,onChange:s=>w(a=>({...a,year:s.target.value})),children:["2024","2025","2026"].map(s=>e.jsx(P,{value:s,children:s},s))})]}),e.jsxs(Y,{size:"small",children:[e.jsx(_,{children:"Calc. Basis"}),e.jsxs(W,{label:"Calc. Basis",value:l.calculationBasis,onChange:s=>w(a=>({...a,calculationBasis:s.target.value})),children:[e.jsx(P,{value:"monthDays",children:"Month Days"}),e.jsx(P,{value:"workingDays",children:"Working Days"})]})]}),e.jsxs(Y,{disabled:!l.month||!l.year,className:"col-span-1",size:"small",children:[e.jsx(_,{children:"Select Employee"}),e.jsx(W,{label:"Select Employee",value:M,onChange:s=>be(s.target.value),children:q.map(s=>{var a;return e.jsx(P,{value:s._id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{src:s.profileimage,sx:{width:24,height:24}}),(a=s.userid)==null?void 0:a.name]})},s._id)})})]})]})]}),i&&e.jsxs(k,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Attendance Summary"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col  gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Total Days",value:r.totalDays}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Holidays",value:r.holidaysCount}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Weekly Offs",value:r.weeklyOff}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Working Days",value:r.workingDays}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Present Days",value:l.presentDays||0}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Leave Days",value:l.leaveDays||0}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Absent Days",value:l.absentDays||0})]}),e.jsx(D,{}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(x,{size:"small",label:"OverTime Minutes",value:r.overtime||0}),e.jsx(x,{size:"small",label:"ShortTime Minutes",value:r.shortmin||0}),e.jsx(x,{size:"small",label:"Per day Salary",value:v(g),helperText:"For Leave/ Absent Calculations"}),e.jsx(x,{size:"small",label:"Per minute Salary",value:v(O),helperText:"For OverTime/ ShortTime Calculations"})]})]})]}),i&&e.jsxs(k,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Adjustments"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col gap-2 mt-4",children:[r!=null&&r.overtime?e.jsx(z,{control:e.jsx(L,{checked:u.addOvertime,onChange:s=>y(a=>({...a,addOvertime:s.target.checked}))}),label:"Add Overtime as Bonus"}):"",r!=null&&r.shortmin?e.jsx(z,{control:e.jsx(L,{checked:u.deductShortTime,onChange:s=>y(a=>({...a,deductShortTime:s.target.checked}))}),label:"Deduct Short Time"}):"",l!=null&&l.absentDays?e.jsx(z,{control:e.jsx(L,{checked:u.deductAbsent,onChange:s=>y(a=>({...a,deductAbsent:s.target.checked}))}),label:"Deduct Absent Days"}):"",l!=null&&l.leaveDays?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(z,{control:e.jsx(L,{checked:u.adjustLeave,onChange:s=>y(a=>({...a,adjustLeave:s.target.checked}))}),label:"Adjust Paid Leaves"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Available Paid leaves: ",A]}),u.adjustLeave&&e.jsx(x,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Count",inputProps:{min:0,max:Math.min(A,l.leaveDays)},value:u.adjustedLeaveCount,onChange:s=>{const a=Number(s.target.value),t=Math.min(A,l.leaveDays);y(o=>({...o,adjustedLeaveCount:Math.max(0,Math.min(a,t))}))}})]}):"",S>0?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(z,{control:e.jsx(L,{checked:u.adjustAdvance,onChange:s=>y(a=>({...a,adjustAdvance:s.target.checked}))}),label:"Adjust Advance"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Advance: ",S]}),u.adjustAdvance&&e.jsx(x,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Advance",inputProps:{min:0,max:S},value:u.adjustedAdvance,onChange:s=>{const a=Number(s.target.value);a<0?y(t=>({...t,adjustedAdvance:0})):a>S?y(t=>({...t,adjustedAdvance:S})):y(t=>({...t,adjustedAdvance:a}))}})]}):""]})]}),i&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Allowances"}),e.jsx(b,{variant:"h6",children:v(T)})]}),e.jsx(D,{}),l.allowances.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Name",className:"flex-5",value:s.name,onChange:t=>I("allowances",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",label:"Amount",className:"flex-2",InputProps:{readOnly:s.inputDisabled||!1},value:s.amount,onChange:t=>I("allowances",a,"amount",t.target.value)}),e.jsx(ae,{onClick:()=>Q("allowances",a),children:e.jsx(se,{})})]},a)),e.jsx(J,{startIcon:e.jsx(te,{}),variant:"outlined",onClick:()=>K("allowances",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2 flex-1",children:"Add Allowance"})]}),i&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Bonuses"}),e.jsx(b,{variant:"h6",children:v(F)})]}),e.jsx(D,{}),l.bonuses.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Name",className:"flex-5",value:s.name,helperText:s.extraInfo??"",onChange:t=>I("bonuses",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",label:"Amount",InputProps:{readOnly:s.inputDisabled||!1},className:"flex-2",value:s.amount,onChange:t=>I("bonuses",a,"amount",t.target.value)}),e.jsx(ae,{className:"flex-1",onClick:()=>Q("bonuses",a),children:e.jsx(se,{})})]},a)),e.jsx(J,{variant:"outlined",startIcon:e.jsx(te,{}),onClick:()=>K("bonuses",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Bonus"})]}),i&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Deductions"}),e.jsx(b,{variant:"h6",children:v(E)})]}),e.jsx(D,{}),l.deductions.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Deduction",className:"flex-5",value:s.name,helperText:s.extraInfo??"",onChange:t=>I("deductions",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",className:"flex-2",label:"Amount",InputProps:{readOnly:(s==null?void 0:s.inputDisabled)||!1},value:s.amount,onChange:t=>I("deductions",a,"amount",t.target.value)}),e.jsx(ae,{className:"flex-1",onClick:()=>Q("deductions",a),children:e.jsx(se,{})})]},a)),e.jsx(J,{variant:"outlined",startIcon:e.jsx(te,{}),onClick:()=>K("deductions",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Deduction"})]}),i&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Salary Summary"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col gap-2 text-right mt-3",children:[e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Base Salary :"}),e.jsx("div",{className:"w-[100px] font-semibold",children:v((i==null?void 0:i.salary)||0)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Allowances :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",v(T)]})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Bonuses :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",v(F)]})]}),e.jsx(D,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:"Gross Salary :"}),e.jsx("div",{className:"w-[100px]",children:v(B)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Deductions :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["-",v(E)," "]})]}),e.jsx(D,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:" Net Salary "}),e.jsx("div",{className:"w-[100px]",children:v(xe)})]}),e.jsxs("div",{className:"capitalize text-xs",children:[" In Words:- ",Je(xe)," "]})]})]}),i&&e.jsx("div",{className:"col-span-2",children:e.jsx(J,{variant:"contained",color:"primary",onClick:Oe,disabled:ne||!M,children:ne?"Saving...":"Save Payroll"})}),re&&e.jsx("p",{className:"text-green-600 mt-2",children:re}),de&&e.jsx("p",{className:"text-red-600 mt-2",children:de})]})}export{aa as default};
