import{h as c,r as b,g as ee,a as te,j as e,k as se,A as re,a3 as ne,T as le,b as de,i as Y,a5 as oe,a6 as ce,a7 as ie,F as T,I as R,S as B,M as S,O as X,C as Z,B as he,a8 as xe}from"./index-C0rwx7oP.js";import{i as me}from"./isBetween-C1ouZG3w.js";import{l as ue}from"./localeData-BjczfUDQ.js";import{H as ae}from"./index-wsrWaM7R.js";const be=({filters:i,theme:P,setcsvcall:$,csvcall:_})=>{const f=c(`${i.year}-${i.month}-01`),H=(f.isSame(c(),"month")?c():f.endOf("month")).date(),[o,z]=b.useState([]),w=Array.from({length:H},(t,a)=>f.date(a+1)),{employee:I,attandence:g,holidays:v,company:A,leaveBalance:C}=ee(t=>t.user);b.useEffect(()=>{_&&(W(),$(!1))},[_]),b.useEffect(()=>{const t=c(`${i.year}-${i.month}-01`),a=C.filter(n=>{if(n.type!=="debit"||!n.period)return!1;const[d,r]=n.period.split("-");return c(`${r}-${d}-01`,"YYYY-M-DD").isSame(t,"month")});z(a)},[i]);const m=I.filter(t=>{var r,u,x;if(!t.status)return!1;const a=i.searchText.trim()===""||((u=(r=t.userid)==null?void 0:r.name)==null?void 0:u.toLowerCase().includes(i.searchText.toLowerCase())),n=i.department==="all"||((x=t==null?void 0:t.department)==null?void 0:x._id)===i.department,d=i.branch==="all"||(t==null?void 0:t.branchId)===i.branch;return a&&n&&d});let k=te();const p={};g==null||g.filter(t=>c(t.date).isSame(f,"month")).forEach(t=>{const a=t.employeeId._id;p[a]||(p[a]={}),p[a][c(t.date).date()]=t.status});const F=new Set;v==null||v.forEach(t=>{const a=c(t.fromDate),n=c(t.toDate);for(let d=a;d.isBefore(n)||d.isSame(n,"day");d=d.add(1,"day"))d.isSame(f,"month")&&F.add(d.date())});const U=(A==null?void 0:A.weeklyOffs)||[],L=(t,a)=>{var r;let n=((r=p[t])==null?void 0:r[a])||"-";n==="present"?n="P":n==="leave"?n="L":n==="absent"?n="A":n==="weekly off"?n="W":n==="holiday"&&(n="H");const d=P?{P:"bg-green-200 text-green-900",A:"bg-red-200 text-red-900",L:"bg-red-200 text-red-900",W:"bg-yellow-200 text-yellow-900",H:"bg-blue-200 text-blue-900"}:{P:"bg-green-900 text-green-100",A:"bg-red-900 text-red-100",L:"bg-red-500 text-red-100",W:"bg-yellow-900 text-yellow-100",H:"bg-blue-900 text-blue-100"};return e.jsx("td",{className:"w-9 h-9 text-center",children:e.jsx("div",{className:`${n==="-"||!P?"":"border border-dashed"} w-7 h-7 flex items-center justify-center mx-auto font-semibold rounded ${d[n]||""}`,children:n})},a)},O=t=>{const a={P:0,A:0,L:0,W:0,H:0,LA:0,NW:0};w.forEach(d=>{var u;let r=((u=p[t])==null?void 0:u[d.date()])||"-";if(F.has(d.date()))r="H";else{const x=f.date(d.date()).day();U.includes(x)&&(r="W")}r==="present"&&(r="P"),r==="leave"&&(r="L"),r==="absent"&&(r="A"),a[r]!==void 0&&a[r]++});const n=o.filter(d=>{var r;return((r=d.employeeId)==null?void 0:r._id)===t}).reduce((d,r)=>d+(r.amount||0),0);return a.LA+=n,a.NW=a.P+a.W+a.H+a.LA,a},W=()=>{const t=[`Attendance Register - ${c(`${i.year}-${i.month}-01`).format("MMMM-YYYY")}`],a=["Employee",...w.map(j=>j.format("DD")),"Present","Absent","Leave","Weekly Off","Holiday","Leave Adjusted","Net Payable Days"],n=m.map(j=>{var y;const N=O(j._id),l=w.map(M=>{var D;let h=((D=p[j._id])==null?void 0:D[M.date()])||"-";return h==="present"&&(h="P"),h==="leave"&&(h="L"),h==="absent"&&(h="A"),h==="weekly off"&&(h="W"),h==="holiday"&&(h="H"),h});return[((y=j==null?void 0:j.userid)==null?void 0:y.name)||"Unknown",...l,N.P,N.A,N.L,N.W,N.H,N.LA,N.NW]}),d=[t,a,...n].map(j=>j.join(",")).join(`
`),r=new Blob([d],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(r),x=document.createElement("a");x.href=u,x.download=`Attendance Register ${c(`${i.year}-${i.month}-01`).format("MMMM-YYYY")}.csv`,x.click(),URL.revokeObjectURL(u)},s="https://res.cloudinary.com/dusxlxlvm/image/upload/v1753113610/ems/assets/employee_fi3g5p.webp";return e.jsxs("div",{className:"overflow-auto ",children:[((m==null?void 0:m.length)<1||Object.keys(p).length===0)&&e.jsx("p",{className:"text-center font-semibold text-xl",colSpan:w.length+6,children:"No Record Found"}),(m==null?void 0:m.length)>0&&Object.keys(p).length!==0&&e.jsxs("table",{className:"border-collapse text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:" border-t border-gray-400 text-gray-500",children:[e.jsx("th",{className:"sticky left-0 bg-white font-bold min-w-[180px] text-left",children:"Employee"}),w.map(t=>e.jsxs("th",{className:"w-9 border border-gray-400 min-w-[35px] text-center",children:[e.jsx("div",{children:t.format("DD")}),e.jsx("div",{children:t.format("ddd")})]},t.date())),e.jsx("th",{title:"Present",className:"px-2 border-r border-gray-500 text-green-800",children:"P"}),e.jsx("th",{title:"Absent",className:"px-2 border-r border-gray-500 text-red-800",children:"A"}),e.jsx("th",{title:"Leave",className:"px-2 border-r border-gray-500 text-orange-600",children:"L"}),e.jsx("th",{title:"Weekly Off",className:"px-2 border-r border-gray-500 text-gray-800",children:"W"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"H"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"LA"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"NP"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r ",children:"Actions"})]})}),e.jsx("tbody",{children:m==null?void 0:m.map(t=>{var n,d;const a=O(t._id);return e.jsxs("tr",{className:"border-y border-gray-300",children:[e.jsx("td",{className:"sticky py-1 left-0 bg-white min-w-[150px] font-semibold",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:se(t==null?void 0:t.profileimage,{format:"webp",width:100,height:100})||s,onError:r=>{r.target.src=s},alt:((n=t==null?void 0:t.userid)==null?void 0:n.name)||"Employee",className:"w-8 h-8 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-800",children:(d=t==null?void 0:t.userid)==null?void 0:d.name}),e.jsxs("p",{className:"text-[10px] text-gray-600",children:["(",t==null?void 0:t.designation,")"]})]})]})}),w.map(r=>L(t._id,r.date())),e.jsx("td",{className:"text-center font-bold text-green-800",children:a.P}),e.jsx("td",{className:"text-center font-bold text-red-800",children:a.A}),e.jsx("td",{className:"text-center font-bold text-orange-600",children:a.L}),e.jsx("td",{className:"text-center font-bold text-gray-800",children:a.W}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.H}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.LA}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.NW}),e.jsx("td",{className:" border-r border-gray-300",children:e.jsx("div",{className:"action flex justify-center gap-2",children:e.jsx("span",{className:"text-[18px] text-amber-500 cursor-pointer",title:"Attandence Report",onClick:()=>k(`/dashboard/performance/${t.userid._id}`),children:e.jsx(ae,{})})})})]},t._id)})}),e.jsx("tfoot",{children:e.jsx("tr",{children:e.jsx("td",{colSpan:w.length+6,className:"py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 text-xs font-semibold",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-green-200 border border-green-600 rounded"}),e.jsx("span",{children:"P = Present"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-red-200 border border-red-600 rounded"}),e.jsx("span",{children:"A = Absent"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-orange-200 border border-orange-600 rounded"}),e.jsx("span",{children:"L = Leave"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-yellow-200 border border-yellow-600 rounded"}),e.jsx("span",{children:"W = Weekly Off"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"H = Holiday"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"LA = Leave Availed/Adjusted"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"NP = Net Payable Days"})]})]})})})})]})]})};c.extend(ue);c.extend(me);const pe=()=>{var W;const[i,P]=b.useState([]),[$,_]=b.useState([]),[f,V]=b.useState(!0),[q,H]=b.useState(!1),[o,z]=b.useState({searchText:"",branch:"all",department:"all",month:c().month()+1,year:c().year()});let w=te();const{department:I,branch:g,employee:v,attandence:A,holidays:C,company:m,profile:k}=ee(s=>s.user),p="https://res.cloudinary.com/dusxlxlvm/image/upload/v1753113610/ems/assets/employee_fi3g5p.webp";b.useEffect(()=>{o.branch==="all"?_([]):_(I.filter(s=>{var t;return((t=s==null?void 0:s.branchId)==null?void 0:t._id)===o.branch}))},[o.branch,I]);const[F,U]=b.useState({totalDays:0,holidaysCount:0,weeklyOff:0,workingDays:0});b.useEffect(()=>{var N;if((v==null?void 0:v.length)<1)return;const s=c(`${o.year}-${o.month}-01`),t=s.isSame(c(),"month"),n=(t?c():s.endOf("month")).date();let d=0;for(let l=1;l<=n;l++){const y=s.date(l);(N=m==null?void 0:m.weeklyOffs)!=null&&N.includes(y.day())&&d++}let r=0;C==null||C.forEach(l=>{const y=c(l.fromDate),M=c(l.toDate);for(let h=1;h<=n;h++){const D=s.date(h);if(t&&D.isAfter(c(),"day"))break;D.isBetween(y,M,"day","[]")&&r++}});const u=n-(d+r);U({totalDays:n,workingDays:u,weeklyOff:d,holidaysCount:r});const x={};A==null||A.filter(l=>c(l.date).isSame(s,"month")).forEach(l=>{const y=l.employeeId._id;x[y]||(x[y]=[]),x[y].push(l)});const j=v.filter(l=>l.status).map((l,y)=>{var J,K,Q;const M=x[l._id]||[],h=M.filter(E=>E.status==="present").length,D=M.filter(E=>E.status==="absent").length,G=M.filter(E=>E.status==="leave").length;return{id:l._id,rawname:(J=l==null?void 0:l.userid)==null?void 0:J.name,branch:l==null?void 0:l.branchId,department:(K=l==null?void 0:l.department)==null?void 0:K._id,name:e.jsxs("div",{className:"flex items-center capitalize gap-3",children:[e.jsx(re,{src:se(l.profileimage,{format:"webp",width:100,height:100})||p,alt:l.employeename}),e.jsxs(ne,{children:[e.jsx(le,{variant:"body2",children:(Q=l==null?void 0:l.userid)==null?void 0:Q.name}),e.jsxs("p",{className:"text-[10px] text-gray-600",children:["(",l==null?void 0:l.designation,")"]})]})]}),totalDays:h+D+G+r+d,weeklyOff:d,holidayCount:r,leave:G,absent:D,present:h,action:e.jsx("div",{className:"action flex gap-2.5",children:e.jsx("span",{className:"text-[18px] text-amber-500 cursor-pointer",title:"Attandence Report",onClick:()=>w(`/dashboard/performance/${l.userid._id}`),children:e.jsx(ae,{})})})}});P(j)},[v,A,C,o.month,o.year,m.weeklyoff]);const L=(s,t)=>{z(a=>({...a,[s]:t}))};b.useMemo(()=>i.filter(s=>{var x;const t=((x=s.rawname)==null?void 0:x.toLowerCase())||"",a=s.department||"",n=s.branch||"",d=o.searchText.trim()===""||t.includes(o.searchText.toLowerCase()),r=o.department==="all"||a===o.department,u=o.branch==="all"||n===o.branch;return d&&r&&u}),[i,o]);const O=()=>{H(!0)};return e.jsxs("div",{className:"employee p-2 ",children:[e.jsxs("div",{className:"flex  flex-wrap gap-3 items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex  flex-wrap gap-3 items-center",children:[e.jsx(de,{size:"small",className:"md:w-[160px] w-full",value:o.searchText,onChange:s=>L("searchText",s.target.value),InputProps:{startAdornment:e.jsx(Y,{position:"start",children:e.jsx(ie,{})}),endAdornment:o.searchText&&e.jsx(Y,{position:"end",children:e.jsx(oe,{onClick:()=>L("searchText",""),edge:"end",size:"small",children:e.jsx(ce,{})})})},label:"Search Employee"}),e.jsxs(T,{size:"small",className:"md:w-[140px] w-[47%]",children:[e.jsx(R,{children:"Branch"}),e.jsxs(B,{value:o.branch,onChange:s=>L("branch",s.target.value),input:e.jsx(X,{startAdornment:e.jsx(Y,{position:"start",children:e.jsx(Z,{fontSize:"small"})}),label:"Branch"}),children:[e.jsx(S,{value:"all",children:"All"}),(k==null?void 0:k.role)==="manager"?(W=g==null?void 0:g.filter(s=>{var t;return(t=k==null?void 0:k.branchIds)==null?void 0:t.includes(s._id)}))==null?void 0:W.map(s=>e.jsx(S,{value:s._id,children:s.name},s._id)):g==null?void 0:g.map(s=>e.jsxs(S,{value:s._id,children:[" ",s.name," "]},s._id))]})]}),e.jsxs(T,{size:"small",className:"md:w-[140px] w-[47%]",children:[e.jsx(R,{children:"Department"}),e.jsxs(B,{disabled:o.branch==="all",value:o.department,input:e.jsx(X,{startAdornment:e.jsx(Y,{position:"start",children:e.jsx(Z,{fontSize:"small"})}),label:"Department"}),onChange:s=>L("department",s.target.value),children:[e.jsx(S,{value:"all",children:"All"}),$.length>0?$.map(s=>e.jsx(S,{value:s._id,children:s.department},s._id)):e.jsx(S,{disabled:!0,children:"No departments found"})]})]}),e.jsxs(T,{size:"small",className:"md:w-[130px] w-[47%]",children:[e.jsx(R,{children:"Month"}),e.jsx(B,{value:o.month,label:"Month",onChange:s=>L("month",s.target.value),children:c.months().map((s,t)=>e.jsx(S,{value:t+1,children:s},t+1))})]}),e.jsxs(T,{size:"small",className:"md:w-[100px] w-[47%]",children:[e.jsx(R,{children:"Year"}),e.jsx(B,{value:o.year,label:"Year",onChange:s=>L("year",s.target.value),children:Array.from({length:5},(s,t)=>c().year()-2+t).map(s=>e.jsx(S,{value:s,children:s},s))})]})]}),e.jsx("div",{className:" w-full md:w-fit",children:e.jsx(he,{onClick:O,className:"flex-1",variant:"outlined",startIcon:e.jsx(xe,{}),children:"Export"})})]}),e.jsxs("div",{className:"mt-4 bg-white rounded shadow p-1 md:p-3",children:[e.jsxs("div",{className:"text-xl relative font-semibold flex justify-between mb-5",children:[e.jsxs("p",{className:"text-gray-700",children:["Daily Attendance Report -"," ",c(`${o.year}-${o.month}-01`).format("MMMM YYYY")]}),e.jsxs("label",{className:"inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:()=>V(!f),className:"sr-only peer"}),e.jsx("div",{className:"w-12 h-6 bg-gray-200 rounded-full peer-checked:bg-blue-600 relative transition-colors"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:f?"Light Theme":"Dark Theme"})]})]}),e.jsx(be,{csvcall:q,filters:o,setcsvcall:H,theme:f})]})]})};export{pe as default};
