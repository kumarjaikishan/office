import{g as E,r as l,a as B,u as J,j as e,C as _,A as j,F as y,y as A,h as w}from"./index-CjW4X5Ur.js";import{D as L}from"./dashboardCard-DbRoXSkR.js";import{d as c}from"./dayjs.min-Dpf_s3do.js";import{F as O,I as C,S as D,O as F}from"./Select-Ac0ty6HW.js";import{M as x}from"./MenuItem-C0OQJkhO.js";import{I as z}from"./InputAdornment-D8n0xtJw.js";import{T as U}from"./Tooltip-CPjxSs-t.js";import"./createSimplePaletteValueFilter-Dr898dzn.js";import"./useSlotProps-B5VaySyr.js";import"./ButtonBase-ByYBLvss.js";import"./Typography-ASPArm2Z.js";import"./Popper-DG9yMcSj.js";const le=()=>{var S;const{attandence:o,employee:m,branch:u,department:h}=E(s=>s.user),{islogin:P,isadmin:G}=E(s=>s.auth),[b,k]=l.useState([]),[N,T]=l.useState([]);let M=B();const I=J(),R=l.useRef(o),[d,$]=l.useState("all"),[p,v]=l.useState("all"),[f,q]=l.useState([]);return l.useEffect(()=>{!P&&M("/login")},[]),l.useEffect(()=>{if(!m||m.length===0)return;const s=m.filter(r=>{const t=d==="all"||r.branchId===d,a=p==="all"||r.department._id===p;return t&&a});q(s)},[d,p,m]),l.useEffect(()=>{v("all")},[d]),l.useEffect(()=>{R.current=o},[o]),l.useEffect(()=>{if(!o)return;let s=o.filter(t=>c(t.date).isSame(c(),"day")&&!t.punchOut),r=o.filter(t=>c(t.date).isSame(c(),"day"));k(s),T(r)},[o]),l.useEffect(()=>{let s=null,r=1e3,t=1e4,a=null;return(()=>{a=new EventSource("/events"),a.onopen=()=>{console.log("✅ SSE connection established successfully"),r=1e3},a.onmessage=g=>{try{const i=JSON.parse(g.data);if(i.type==="attendance_update"){console.log(i.payload.action,i.payload.data);let n=i.payload.data;i.payload.action==="checkin"&&(A(e.jsxs("div",{className:"flex items-center gap-2 pr-1",children:[e.jsx(j,{src:n.employeeId.profileimage,alt:n.employeeId.employeename,children:!n.employeeId.profileimage&&e.jsx(y,{})}),e.jsxs("span",{className:"text-[14px] ",children:[e.jsxs("span",{className:"text-green-700 capitalize font-semibold",children:[" ",n.employeeId.userid.name]})," has Punched In at"," ",e.jsxs("span",{className:"text-green-700 ",children:[" ",c(n.punchIn).format("hh:mm A")]})]})]}),{autoClose:2e4}),I(w())),i.payload.action==="checkOut"&&(A(e.jsxs("div",{className:"flex items-center gap-2 pr-1",children:[e.jsx(j,{src:n.employeeId.profileimage,alt:n.employeeId.employeename,children:!n.employeeId.profileimage&&e.jsx(y,{})}),e.jsxs("span",{className:"text-[14px] ",children:[e.jsxs("span",{className:"text-amber-700 capitalize font-semibold ",children:[" ",n.employeeId.userid.name]})," has Punched Out at"," ",e.jsxs("span",{className:"text-amber-700 ",children:[" ",c(n.punchOut).format("hh:mm A")]})]})]}),{autoClose:2e4}),I(w()))}}catch(i){console.error("Failed to parse SSE message:",i)}},a.onerror=g=>{console.warn("SSE connection lost, retrying...",g),a.close(),s=setTimeout(()=>{r=Math.min(r*2,t)},r)}})(),()=>{a&&a.close(),s&&clearTimeout(s)}},[]),e.jsxs("div",{className:"p-0  md:p-3",children:[e.jsx("div",{className:"mb-3 ",children:e.jsx(L,{employee:m,todaypresent:N.length,currentpresent:b.length})}),e.jsxs("div",{className:"w-full flex-col flex gap-5 shadow  bg-white p-2 rounded",children:[e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsxs(O,{sx:{width:"160px"},required:!0,size:"small",children:[e.jsx(C,{id:"demo-simple-select-helper-label",children:"Branch"}),e.jsxs(D,{value:d,input:e.jsx(F,{startAdornment:e.jsx(z,{position:"start",children:e.jsx(_,{fontSize:"small"})}),label:"branch"}),onChange:s=>$(s.target.value),children:[e.jsx(x,{selected:!0,value:"all",children:"All"}),u==null?void 0:u.map(s=>e.jsx(x,{value:s._id,children:s.name},s._id))]})]}),e.jsxs(O,{sx:{width:"160px"},required:!0,size:"small",children:[e.jsx(C,{id:"demo-simple-select-helper-label",children:"Department"}),e.jsxs(D,{disabled:d=="all",value:p,input:e.jsx(F,{startAdornment:e.jsx(z,{position:"start",children:e.jsx(_,{fontSize:"small"})}),label:"Department"}),onChange:s=>v(s.target.value),children:[e.jsx(x,{selected:!0,value:"all",children:"All"}),(S=h==null?void 0:h.filter(s=>s.branchId._id==d))==null?void 0:S.map(s=>e.jsx(x,{value:s._id,children:s.department},s._id))]})]})]}),e.jsx("div",{className:"grid grid-cols-5 md:grid-cols-10 lg:grid-cols-15 gap-2 md:gap-4",children:f==null?void 0:f.map(s=>{const r=b.some(a=>a.employeeId._id===s._id),t=N.find(a=>a.employeeId._id===s._id);return e.jsx(U,{arrow:!0,enterDelay:800,placement:"top",title:e.jsxs("div",{className:"flex flex-col ",children:[e.jsxs("span",{children:[" In       ",t!=null&&t.punchIn?c(t.punchIn).format("hh:mm A"):" -:-"]}),e.jsxs("span",{children:[" Out    ",t!=null&&t.punchOut?c(t.punchOut).format("hh:mm A"):"-:-"]})]}),children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`${t?r?"border-green-500":"border-amber-400":"border-gray-300"} p-[2px] border-3 rounded-full`,children:e.jsx(j,{src:s.profileimage,alt:s.employeename,children:!s.profileimage&&e.jsx(y,{})})}),e.jsx("p",{className:`${t?r?"text-green-600 text-[14px]":"text-amber-700":"text-gray-500"} text-[12px] text-center transition-all duration-300 capitalize `,children:s.userid.name})]},s._id)},s._id)})}),e.jsxs("div",{className:"flex gap-5",children:[e.jsxs("span",{className:"flex items-center gap-1 text-green-500 text-[13px] ",children:[e.jsx("span",{className:"block w-[15px] rounded-3xl h-[15px] bg-green-500 "})," In Premise"]}),e.jsxs("span",{className:"flex items-center gap-1 text-amber-700 text-[13px]",children:[e.jsx("span",{className:"block w-[15px] rounded-3xl h-[15px] bg-amber-500 "})," Present"]}),e.jsxs("span",{className:"flex items-center gap-1 text-gray-500 text-[13px]",children:[e.jsx("span",{className:"block w-[15px] rounded-3xl h-[15px] bg-gray-500  "})," Absent"]})]})]})]})};export{le as default};
