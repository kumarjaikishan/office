import{h as c,r as j,g as X,a as Z,j as e,k as ee,A as se,a3 as ae,T as re,b as ne,i as T,a5 as le,a6 as de,a7 as oe,F as R,I as B,S as z,M,O as K,C as Q,B as ce,a8 as ie}from"./index-CnwpFnDy.js";import{i as he}from"./isBetween-C1vB8b60.js";import{l as xe}from"./localeData-hL3urFII.js";import{H as te}from"./index-M3l5cMki.js";const me=({filters:i,theme:H,setcsvcall:O,csvcall:E})=>{const u=c(`${i.year}-${i.month}-01`),I=(u.isSame(c(),"month")?c():u.endOf("month")).date(),[o,F]=j.useState([]),p=Array.from({length:I},(t,a)=>u.date(a+1)),{employee:W,attandence:L,holidays:N,company:k,leaveBalance:C}=X(t=>t.user);j.useEffect(()=>{E&&(h(),O(!1))},[E]),j.useEffect(()=>{const t=c(`${i.year}-${i.month}-01`),a=C.filter(l=>{if(l.type!=="debit"||!l.period)return!1;const[d,n]=l.period.split("-");return c(`${n}-${d}-01`,"YYYY-M-DD").isSame(t,"month")});F(a)},[i]);const m=W.filter(t=>{var n,b,g;if(!t.status)return!1;const a=i.searchText.trim()===""||((b=(n=t.userid)==null?void 0:n.name)==null?void 0:b.toLowerCase().includes(i.searchText.toLowerCase())),l=i.department==="all"||((g=t==null?void 0:t.department)==null?void 0:g._id)===i.department,d=i.branch==="all"||(t==null?void 0:t.branchId)===i.branch;return a&&l&&d});let U=Z();const w={};L==null||L.filter(t=>c(t.date).isSame(u,"month")).forEach(t=>{const a=t.employeeId._id;w[a]||(w[a]={}),w[a][c(t.date).date()]=t.status});const _=new Set;N==null||N.forEach(t=>{const a=c(t.fromDate),l=c(t.toDate);for(let d=a;d.isBefore(l)||d.isSame(l,"day");d=d.add(1,"day"))d.isSame(u,"month")&&_.add(d.date())});const y=(k==null?void 0:k.weeklyOffs)||[],V=(t,a)=>{var n;let l=((n=w[t])==null?void 0:n[a])||"-";if(l==="present"&&(l="P"),l==="leave"&&(l="L"),l==="absent"&&(l="A"),_.has(a))l="H";else{const b=u.date(a).day();y.includes(b)&&(l="W")}const d=H?{P:"bg-green-200 text-green-900",A:"bg-red-200 text-red-900",L:"bg-red-200 text-red-900",W:"bg-yellow-200 text-yellow-900",H:"bg-blue-200 text-blue-900"}:{P:"bg-green-900 text-green-100",A:"bg-red-900 text-red-100",L:"bg-red-500 text-red-100",W:"bg-yellow-900 text-yellow-100",H:"bg-blue-900 text-blue-100"};return e.jsx("td",{className:"w-9 h-9 text-center",children:e.jsx("div",{className:`${l=="-"||!H?"":"border border-dashed"} w-7 h-7 
         flex items-center justify-center mx-auto font-semibold
         rounded  ${d[l]||""}`,children:l})},a)},s=t=>{const a={P:0,A:0,L:0,W:0,H:0,LA:0,NW:0};p.forEach(d=>{var b;let n=((b=w[t])==null?void 0:b[d.date()])||"-";if(_.has(d.date()))n="H";else{const g=u.date(d.date()).day();y.includes(g)&&(n="W")}n==="present"&&(n="P"),n==="leave"&&(n="L"),n==="absent"&&(n="A"),a[n]!==void 0&&a[n]++});const l=o.filter(d=>{var n;return((n=d.employeeId)==null?void 0:n._id)===t}).reduce((d,n)=>d+(n.amount||0),0);return a.LA+=l,a.NW=a.P+a.W+a.H+a.LA,a},h=()=>{const t=[`Attendance Register - ${c(`${i.year}-${i.month}-01`).format("MMMM-YYYY")}`],a=["Employee",...p.map(r=>r.format("DD")),"Present","Absent","Leave","Weekly Off","Holiday","Leave Adjusted","Net Payable Days"],l=m.map(r=>{var v;const x=s(r._id),S=p.map(A=>{var P;let f=((P=w[r._id])==null?void 0:P[A.date()])||"-";if(_.has(A.date()))f="H";else{const Y=u.date(A.date()).day();y.includes(Y)&&(f="W")}return f==="present"&&(f="P"),f==="leave"&&(f="L"),f==="absent"&&(f="A"),f});return[((v=r==null?void 0:r.userid)==null?void 0:v.name)||"Unknown",...S,x.P,x.A,x.L,x.W,x.H,x.LA,x.NW]}),d=[t,a,...l].map(r=>r.join(",")).join(`
`),n=new Blob([d],{type:"text/csv;charset=utf-8;"}),b=URL.createObjectURL(n),g=document.createElement("a");g.href=b,g.download=`Attendance Register ${c(`${i.year}-${i.month}-01`).format("MMMM-YYYY")}.csv`,g.click(),URL.revokeObjectURL(b)},D="https://res.cloudinary.com/dusxlxlvm/image/upload/v1753113610/ems/assets/employee_fi3g5p.webp";return e.jsxs("div",{className:"overflow-auto",children:[((m==null?void 0:m.length)<1||Object.keys(w).length===0)&&e.jsx("p",{className:"text-center font-semibold text-xl",colSpan:p.length+6,children:"No Record Found"}),(m==null?void 0:m.length)>0&&Object.keys(w).length!==0&&e.jsxs("table",{className:"border-collapse text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:" border-t border-gray-400 text-gray-500",children:[e.jsx("th",{className:"sticky left-0 bg-white font-bold min-w-[180px] text-left",children:"Employee"}),p.map(t=>e.jsxs("th",{className:"w-9 border border-gray-400 min-w-[35px] text-center",children:[e.jsx("div",{children:t.format("DD")}),e.jsx("div",{children:t.format("ddd")})]},t.date())),e.jsx("th",{title:"Present",className:"px-2 border-r border-gray-500 text-green-800",children:"P"}),e.jsx("th",{title:"Absent",className:"px-2 border-r border-gray-500 text-red-800",children:"A"}),e.jsx("th",{title:"Leave",className:"px-2 border-r border-gray-500 text-orange-600",children:"L"}),e.jsx("th",{title:"Weekly Off",className:"px-2 border-r border-gray-500 text-gray-800",children:"W"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"H"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"LA"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"NP"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r ",children:"Actions"})]})}),e.jsx("tbody",{children:m==null?void 0:m.map(t=>{var l,d;const a=s(t._id);return e.jsxs("tr",{className:"border-y border-gray-300",children:[e.jsx("td",{className:"sticky py-1 left-0 bg-white min-w-[150px] font-semibold",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:ee(t==null?void 0:t.profileimage,{format:"webp",width:100,height:100})||D,onError:n=>{n.target.src=D},alt:((l=t==null?void 0:t.userid)==null?void 0:l.name)||"Employee",className:"w-8 h-8 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-800",children:(d=t==null?void 0:t.userid)==null?void 0:d.name}),e.jsxs("p",{className:"text-[10px] text-gray-600",children:["(",t==null?void 0:t.designation,")"]})]})]})}),p.map(n=>V(t._id,n.date())),e.jsx("td",{className:"text-center font-bold text-green-800",children:a.P}),e.jsx("td",{className:"text-center font-bold text-red-800",children:a.A}),e.jsx("td",{className:"text-center font-bold text-orange-600",children:a.L}),e.jsx("td",{className:"text-center font-bold text-gray-800",children:a.W}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.H}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.LA}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.NW}),e.jsx("td",{className:" border-r border-gray-300",children:e.jsx("div",{className:"action flex justify-center gap-2",children:e.jsx("span",{className:"text-[18px] text-amber-500 cursor-pointer",title:"Attandence Report",onClick:()=>U(`/dashboard/performance/${t.userid._id}`),children:e.jsx(te,{})})})})]},t._id)})}),e.jsx("tfoot",{children:e.jsx("tr",{children:e.jsx("td",{colSpan:p.length+6,className:"py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 text-xs font-semibold",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-green-200 border border-green-600 rounded"}),e.jsx("span",{children:"P = Present"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-red-200 border border-red-600 rounded"}),e.jsx("span",{children:"A = Absent"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-orange-200 border border-orange-600 rounded"}),e.jsx("span",{children:"L = Leave"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-yellow-200 border border-yellow-600 rounded"}),e.jsx("span",{children:"W = Weekly Off"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"H = Holiday"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"LA = Leave Availed/Adjusted"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"NP = Net Payable Days"})]})]})})})})]})]})};c.extend(xe);c.extend(he);const ge=()=>{const[i,H]=j.useState([]),[O,E]=j.useState([]),[u,q]=j.useState(!0),[G,I]=j.useState(!1),[o,F]=j.useState({searchText:"",branch:"all",department:"all",month:c().month()+1,year:c().year()});let p=Z();const{department:W,branch:L,employee:N,attandence:k,holidays:C,company:m}=X(s=>s.user),U="https://res.cloudinary.com/dusxlxlvm/image/upload/v1753113610/ems/assets/employee_fi3g5p.webp";j.useEffect(()=>{o.branch==="all"?E([]):E(W.filter(s=>{var h;return((h=s==null?void 0:s.branchId)==null?void 0:h._id)===o.branch}))},[o.branch,W]);const[w,_]=j.useState({totalDays:0,holidaysCount:0,weeklyOff:0,workingDays:0});j.useEffect(()=>{var g;if((N==null?void 0:N.length)<1)return;const s=c(`${o.year}-${o.month}-01`),h=s.isSame(c(),"month"),t=(h?c():s.endOf("month")).date();let a=0;for(let r=1;r<=t;r++){const x=s.date(r);(g=m==null?void 0:m.weeklyOffs)!=null&&g.includes(x.day())&&a++}let l=0;C==null||C.forEach(r=>{const x=c(r.fromDate),S=c(r.toDate);for(let v=1;v<=t;v++){const A=s.date(v);if(h&&A.isAfter(c(),"day"))break;A.isBetween(x,S,"day","[]")&&l++}});const d=t-(a+l);_({totalDays:t,workingDays:d,weeklyOff:a,holidaysCount:l});const n={};k==null||k.filter(r=>c(r.date).isSame(s,"month")).forEach(r=>{const x=r.employeeId._id;n[x]||(n[x]=[]),n[x].push(r)});const b=N.filter(r=>r.status).map((r,x)=>{var P,Y,J;const S=n[r._id]||[],v=S.filter($=>$.status==="present").length,A=S.filter($=>$.status==="absent").length,f=S.filter($=>$.status==="leave").length;return{id:r._id,rawname:(P=r==null?void 0:r.userid)==null?void 0:P.name,branch:r==null?void 0:r.branchId,department:(Y=r==null?void 0:r.department)==null?void 0:Y._id,name:e.jsxs("div",{className:"flex items-center capitalize gap-3",children:[e.jsx(se,{src:ee(r.profileimage,{format:"webp",width:100,height:100})||U,alt:r.employeename}),e.jsxs(ae,{children:[e.jsx(re,{variant:"body2",children:(J=r==null?void 0:r.userid)==null?void 0:J.name}),e.jsxs("p",{className:"text-[10px] text-gray-600",children:["(",r==null?void 0:r.designation,")"]})]})]}),totalDays:v+A+f+l+a,weeklyOff:a,holidayCount:l,leave:f,absent:A,present:v,action:e.jsx("div",{className:"action flex gap-2.5",children:e.jsx("span",{className:"text-[18px] text-amber-500 cursor-pointer",title:"Attandence Report",onClick:()=>p(`/dashboard/performance/${r.userid._id}`),children:e.jsx(te,{})})})}});H(b)},[N,k,C,o.month,o.year,m.weeklyoff]);const y=(s,h)=>{F(D=>({...D,[s]:h}))};j.useMemo(()=>i.filter(s=>{var n;const h=((n=s.rawname)==null?void 0:n.toLowerCase())||"",D=s.department||"",t=s.branch||"",a=o.searchText.trim()===""||h.includes(o.searchText.toLowerCase()),l=o.department==="all"||D===o.department,d=o.branch==="all"||t===o.branch;return a&&l&&d}),[i,o]);const V=()=>{I(!0)};return e.jsxs("div",{className:"employee p-2",children:[e.jsxs("div",{className:"flex  flex-wrap gap-3 items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex  flex-wrap gap-3 items-center",children:[e.jsx(ne,{size:"small",className:"md:w-[160px] w-full",value:o.searchText,onChange:s=>y("searchText",s.target.value),InputProps:{startAdornment:e.jsx(T,{position:"start",children:e.jsx(oe,{})}),endAdornment:o.searchText&&e.jsx(T,{position:"end",children:e.jsx(le,{onClick:()=>y("searchText",""),edge:"end",size:"small",children:e.jsx(de,{})})})},label:"Search Employee"}),e.jsxs(R,{size:"small",className:"md:w-[140px] w-[47%]",children:[e.jsx(B,{children:"Branch"}),e.jsxs(z,{value:o.branch,onChange:s=>y("branch",s.target.value),input:e.jsx(K,{startAdornment:e.jsx(T,{position:"start",children:e.jsx(Q,{fontSize:"small"})}),label:"Branch"}),children:[e.jsx(M,{value:"all",children:"All"}),L==null?void 0:L.map(s=>e.jsx(M,{value:s._id,children:s.name},s._id))]})]}),e.jsxs(R,{size:"small",className:"md:w-[140px] w-[47%]",children:[e.jsx(B,{children:"Department"}),e.jsxs(z,{disabled:o.branch==="all",value:o.department,input:e.jsx(K,{startAdornment:e.jsx(T,{position:"start",children:e.jsx(Q,{fontSize:"small"})}),label:"Department"}),onChange:s=>y("department",s.target.value),children:[e.jsx(M,{value:"all",children:"All"}),O.length>0?O.map(s=>e.jsx(M,{value:s._id,children:s.department},s._id)):e.jsx(M,{disabled:!0,children:"No departments found"})]})]}),e.jsxs(R,{size:"small",className:"md:w-[130px] w-[47%]",children:[e.jsx(B,{children:"Month"}),e.jsx(z,{value:o.month,label:"Month",onChange:s=>y("month",s.target.value),children:c.months().map((s,h)=>e.jsx(M,{value:h+1,children:s},h+1))})]}),e.jsxs(R,{size:"small",className:"md:w-[100px] w-[47%]",children:[e.jsx(B,{children:"Year"}),e.jsx(z,{value:o.year,label:"Year",onChange:s=>y("year",s.target.value),children:Array.from({length:5},(s,h)=>c().year()-2+h).map(s=>e.jsx(M,{value:s,children:s},s))})]})]}),e.jsx("div",{className:" w-full md:w-fit",children:e.jsx(ce,{onClick:V,className:"flex-1",variant:"outlined",startIcon:e.jsx(ie,{}),children:"Export"})})]}),e.jsxs("div",{className:"mt-4 bg-white rounded shadow p-1 md:p-3",children:[e.jsxs("div",{className:"text-xl relative font-semibold flex justify-between mb-5",children:[e.jsxs("p",{className:"text-gray-700",children:["Daily Attendance Report -"," ",c(`${o.year}-${o.month}-01`).format("MMMM YYYY")]}),e.jsxs("label",{className:"inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:u,onChange:()=>q(!u),className:"sr-only peer"}),e.jsx("div",{className:"w-12 h-6 bg-gray-200 rounded-full peer-checked:bg-blue-600 relative transition-colors"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:u?"Light Theme":"Dark Theme"})]})]}),e.jsx(me,{csvcall:G,filters:o,setcsvcall:I,theme:u})]})]})};export{ge as default};
