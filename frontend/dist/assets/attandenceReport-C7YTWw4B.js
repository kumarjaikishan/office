import{h as c,r as f,g as ee,a as te,j as e,k as se,A as re,a3 as ne,T as le,b as de,i as B,a5 as oe,a6 as ce,a7 as ie,F as z,I as F,S as U,M,O as X,C as Z,B as he,a8 as xe}from"./index-1A7JaBJN.js";import{i as me}from"./isBetween-BonAIWld.js";import{l as ue}from"./localeData-B0Fb_a6C.js";import{H as ae}from"./index-XZUEZq-M.js";const be=({filters:i,theme:H,setcsvcall:I,csvcall:_})=>{const b=c(`${i.year}-${i.month}-01`),O=(b.isSame(c(),"month")?c():b.endOf("month")).date(),[o,V]=f.useState([]),w=Array.from({length:O},(t,a)=>b.date(a+1)),{employee:W,attandence:y,holidays:v,company:k,leaveBalance:C}=ee(t=>t.user);f.useEffect(()=>{_&&(T(),I(!1))},[_]),f.useEffect(()=>{const t=c(`${i.year}-${i.month}-01`),a=C.filter(l=>{if(l.type!=="debit"||!l.period)return!1;const[d,r]=l.period.split("-");return c(`${r}-${d}-01`,"YYYY-M-DD").isSame(t,"month")});V(a)},[i]);const m=W.filter(t=>{var r,u,h;if(!t.status)return!1;const a=i.searchText.trim()===""||((u=(r=t.userid)==null?void 0:r.name)==null?void 0:u.toLowerCase().includes(i.searchText.toLowerCase())),l=i.department==="all"||((h=t==null?void 0:t.department)==null?void 0:h._id)===i.department,d=i.branch==="all"||(t==null?void 0:t.branchId)===i.branch;return a&&l&&d});let L=te();const p={};y==null||y.filter(t=>c(t.date).isSame(b,"month")).forEach(t=>{const a=t.employeeId._id;p[a]||(p[a]={}),p[a][c(t.date).date()]=t.status});const E=new Set;v==null||v.forEach(t=>{const a=c(t.fromDate),l=c(t.toDate);for(let d=a;d.isBefore(l)||d.isSame(l,"day");d=d.add(1,"day"))d.isSame(b,"month")&&E.add(d.date())});const P=(k==null?void 0:k.weeklyOffs)||[],D=(t,a)=>{var r;let l=((r=p[t])==null?void 0:r[a])||"-";if(l==="present"&&(l="P"),l==="leave"&&(l="L"),l==="absent"&&(l="A"),E.has(a))l="H";else{const u=b.date(a).day();P.includes(u)&&(l="W")}const d=H?{P:"bg-green-200 text-green-900",A:"bg-red-200 text-red-900",L:"bg-red-200 text-red-900",W:"bg-yellow-200 text-yellow-900",H:"bg-blue-200 text-blue-900"}:{P:"bg-green-900 text-green-100",A:"bg-red-900 text-red-100",L:"bg-red-500 text-red-100",W:"bg-yellow-900 text-yellow-100",H:"bg-blue-900 text-blue-100"};return e.jsx("td",{className:"w-9 h-9 text-center",children:e.jsx("div",{className:`${l=="-"||!H?"":"border border-dashed"} w-7 h-7 
         flex items-center justify-center mx-auto font-semibold
         rounded  ${d[l]||""}`,children:l})},a)},Y=t=>{const a={P:0,A:0,L:0,W:0,H:0,LA:0,NW:0};w.forEach(d=>{var u;let r=((u=p[t])==null?void 0:u[d.date()])||"-";if(E.has(d.date()))r="H";else{const h=b.date(d.date()).day();P.includes(h)&&(r="W")}r==="present"&&(r="P"),r==="leave"&&(r="L"),r==="absent"&&(r="A"),a[r]!==void 0&&a[r]++});const l=o.filter(d=>{var r;return((r=d.employeeId)==null?void 0:r._id)===t}).reduce((d,r)=>d+(r.amount||0),0);return a.LA+=l,a.NW=a.P+a.W+a.H+a.LA,a},T=()=>{const t=[`Attendance Register - ${c(`${i.year}-${i.month}-01`).format("MMMM-YYYY")}`],a=["Employee",...w.map(j=>j.format("DD")),"Present","Absent","Leave","Weekly Off","Holiday","Leave Adjusted","Net Payable Days"],l=m.map(j=>{var g;const N=Y(j._id),n=w.map(A=>{var S;let x=((S=p[j._id])==null?void 0:S[A.date()])||"-";if(E.has(A.date()))x="H";else{const R=b.date(A.date()).day();P.includes(R)&&(x="W")}return x==="present"&&(x="P"),x==="leave"&&(x="L"),x==="absent"&&(x="A"),x});return[((g=j==null?void 0:j.userid)==null?void 0:g.name)||"Unknown",...n,N.P,N.A,N.L,N.W,N.H,N.LA,N.NW]}),d=[t,a,...l].map(j=>j.join(",")).join(`
`),r=new Blob([d],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(r),h=document.createElement("a");h.href=u,h.download=`Attendance Register ${c(`${i.year}-${i.month}-01`).format("MMMM-YYYY")}.csv`,h.click(),URL.revokeObjectURL(u)},s="https://res.cloudinary.com/dusxlxlvm/image/upload/v1753113610/ems/assets/employee_fi3g5p.webp";return e.jsxs("div",{className:"overflow-auto",children:[((m==null?void 0:m.length)<1||Object.keys(p).length===0)&&e.jsx("p",{className:"text-center font-semibold text-xl",colSpan:w.length+6,children:"No Record Found"}),(m==null?void 0:m.length)>0&&Object.keys(p).length!==0&&e.jsxs("table",{className:"border-collapse text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:" border-t border-gray-400 text-gray-500",children:[e.jsx("th",{className:"sticky left-0 bg-white font-bold min-w-[180px] text-left",children:"Employee"}),w.map(t=>e.jsxs("th",{className:"w-9 border border-gray-400 min-w-[35px] text-center",children:[e.jsx("div",{children:t.format("DD")}),e.jsx("div",{children:t.format("ddd")})]},t.date())),e.jsx("th",{title:"Present",className:"px-2 border-r border-gray-500 text-green-800",children:"P"}),e.jsx("th",{title:"Absent",className:"px-2 border-r border-gray-500 text-red-800",children:"A"}),e.jsx("th",{title:"Leave",className:"px-2 border-r border-gray-500 text-orange-600",children:"L"}),e.jsx("th",{title:"Weekly Off",className:"px-2 border-r border-gray-500 text-gray-800",children:"W"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"H"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"LA"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r border-gray-500 text-blue-800",children:"NP"}),e.jsx("th",{title:"Holiday",className:"px-2 border-r ",children:"Actions"})]})}),e.jsx("tbody",{children:m==null?void 0:m.map(t=>{var l,d;const a=Y(t._id);return e.jsxs("tr",{className:"border-y border-gray-300",children:[e.jsx("td",{className:"sticky py-1 left-0 bg-white min-w-[150px] font-semibold",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:se(t==null?void 0:t.profileimage,{format:"webp",width:100,height:100})||s,onError:r=>{r.target.src=s},alt:((l=t==null?void 0:t.userid)==null?void 0:l.name)||"Employee",className:"w-8 h-8 rounded-full"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-800",children:(d=t==null?void 0:t.userid)==null?void 0:d.name}),e.jsxs("p",{className:"text-[10px] text-gray-600",children:["(",t==null?void 0:t.designation,")"]})]})]})}),w.map(r=>D(t._id,r.date())),e.jsx("td",{className:"text-center font-bold text-green-800",children:a.P}),e.jsx("td",{className:"text-center font-bold text-red-800",children:a.A}),e.jsx("td",{className:"text-center font-bold text-orange-600",children:a.L}),e.jsx("td",{className:"text-center font-bold text-gray-800",children:a.W}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.H}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.LA}),e.jsx("td",{className:"text-center font-bold text-blue-800",children:a.NW}),e.jsx("td",{className:" border-r border-gray-300",children:e.jsx("div",{className:"action flex justify-center gap-2",children:e.jsx("span",{className:"text-[18px] text-amber-500 cursor-pointer",title:"Attandence Report",onClick:()=>L(`/dashboard/performance/${t.userid._id}`),children:e.jsx(ae,{})})})})]},t._id)})}),e.jsx("tfoot",{children:e.jsx("tr",{children:e.jsx("td",{colSpan:w.length+6,className:"py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 text-xs font-semibold",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-green-200 border border-green-600 rounded"}),e.jsx("span",{children:"P = Present"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-red-200 border border-red-600 rounded"}),e.jsx("span",{children:"A = Absent"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-orange-200 border border-orange-600 rounded"}),e.jsx("span",{children:"L = Leave"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-yellow-200 border border-yellow-600 rounded"}),e.jsx("span",{children:"W = Weekly Off"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"H = Holiday"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"LA = Leave Availed/Adjusted"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-4 h-4 bg-blue-200 border border-blue-600 rounded"}),e.jsx("span",{children:"NP = Net Payable Days"})]})]})})})})]})]})};c.extend(ue);c.extend(me);const pe=()=>{var T;const[i,H]=f.useState([]),[I,_]=f.useState([]),[b,q]=f.useState(!0),[G,O]=f.useState(!1),[o,V]=f.useState({searchText:"",branch:"all",department:"all",month:c().month()+1,year:c().year()});let w=te();const{department:W,branch:y,employee:v,attandence:k,holidays:C,company:m,profile:L}=ee(s=>s.user),p="https://res.cloudinary.com/dusxlxlvm/image/upload/v1753113610/ems/assets/employee_fi3g5p.webp";f.useEffect(()=>{o.branch==="all"?_([]):_(W.filter(s=>{var t;return((t=s==null?void 0:s.branchId)==null?void 0:t._id)===o.branch}))},[o.branch,W]);const[E,P]=f.useState({totalDays:0,holidaysCount:0,weeklyOff:0,workingDays:0});f.useEffect(()=>{var N;if((v==null?void 0:v.length)<1)return;const s=c(`${o.year}-${o.month}-01`),t=s.isSame(c(),"month"),l=(t?c():s.endOf("month")).date();let d=0;for(let n=1;n<=l;n++){const g=s.date(n);(N=m==null?void 0:m.weeklyOffs)!=null&&N.includes(g.day())&&d++}let r=0;C==null||C.forEach(n=>{const g=c(n.fromDate),A=c(n.toDate);for(let x=1;x<=l;x++){const S=s.date(x);if(t&&S.isAfter(c(),"day"))break;S.isBetween(g,A,"day","[]")&&r++}});const u=l-(d+r);P({totalDays:l,workingDays:u,weeklyOff:d,holidaysCount:r});const h={};k==null||k.filter(n=>c(n.date).isSame(s,"month")).forEach(n=>{const g=n.employeeId._id;h[g]||(h[g]=[]),h[g].push(n)});const j=v.filter(n=>n.status).map((n,g)=>{var J,K,Q;const A=h[n._id]||[],x=A.filter($=>$.status==="present").length,S=A.filter($=>$.status==="absent").length,R=A.filter($=>$.status==="leave").length;return{id:n._id,rawname:(J=n==null?void 0:n.userid)==null?void 0:J.name,branch:n==null?void 0:n.branchId,department:(K=n==null?void 0:n.department)==null?void 0:K._id,name:e.jsxs("div",{className:"flex items-center capitalize gap-3",children:[e.jsx(re,{src:se(n.profileimage,{format:"webp",width:100,height:100})||p,alt:n.employeename}),e.jsxs(ne,{children:[e.jsx(le,{variant:"body2",children:(Q=n==null?void 0:n.userid)==null?void 0:Q.name}),e.jsxs("p",{className:"text-[10px] text-gray-600",children:["(",n==null?void 0:n.designation,")"]})]})]}),totalDays:x+S+R+r+d,weeklyOff:d,holidayCount:r,leave:R,absent:S,present:x,action:e.jsx("div",{className:"action flex gap-2.5",children:e.jsx("span",{className:"text-[18px] text-amber-500 cursor-pointer",title:"Attandence Report",onClick:()=>w(`/dashboard/performance/${n.userid._id}`),children:e.jsx(ae,{})})})}});H(j)},[v,k,C,o.month,o.year,m.weeklyoff]);const D=(s,t)=>{V(a=>({...a,[s]:t}))};f.useMemo(()=>i.filter(s=>{var h;const t=((h=s.rawname)==null?void 0:h.toLowerCase())||"",a=s.department||"",l=s.branch||"",d=o.searchText.trim()===""||t.includes(o.searchText.toLowerCase()),r=o.department==="all"||a===o.department,u=o.branch==="all"||l===o.branch;return d&&r&&u}),[i,o]);const Y=()=>{O(!0)};return e.jsxs("div",{className:"employee p-2",children:[e.jsxs("div",{className:"flex  flex-wrap gap-3 items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex  flex-wrap gap-3 items-center",children:[e.jsx(de,{size:"small",className:"md:w-[160px] w-full",value:o.searchText,onChange:s=>D("searchText",s.target.value),InputProps:{startAdornment:e.jsx(B,{position:"start",children:e.jsx(ie,{})}),endAdornment:o.searchText&&e.jsx(B,{position:"end",children:e.jsx(oe,{onClick:()=>D("searchText",""),edge:"end",size:"small",children:e.jsx(ce,{})})})},label:"Search Employee"}),e.jsxs(z,{size:"small",className:"md:w-[140px] w-[47%]",children:[e.jsx(F,{children:"Branch"}),e.jsxs(U,{value:o.branch,onChange:s=>D("branch",s.target.value),input:e.jsx(X,{startAdornment:e.jsx(B,{position:"start",children:e.jsx(Z,{fontSize:"small"})}),label:"Branch"}),children:[e.jsx(M,{value:"all",children:"All"}),(L==null?void 0:L.role)==="manager"?(T=y==null?void 0:y.filter(s=>{var t;return(t=L==null?void 0:L.branchIds)==null?void 0:t.includes(s._id)}))==null?void 0:T.map(s=>e.jsx(M,{value:s._id,children:s.name},s._id)):y==null?void 0:y.map(s=>e.jsxs(M,{value:s._id,children:[" ",s.name," "]},s._id))]})]}),e.jsxs(z,{size:"small",className:"md:w-[140px] w-[47%]",children:[e.jsx(F,{children:"Department"}),e.jsxs(U,{disabled:o.branch==="all",value:o.department,input:e.jsx(X,{startAdornment:e.jsx(B,{position:"start",children:e.jsx(Z,{fontSize:"small"})}),label:"Department"}),onChange:s=>D("department",s.target.value),children:[e.jsx(M,{value:"all",children:"All"}),I.length>0?I.map(s=>e.jsx(M,{value:s._id,children:s.department},s._id)):e.jsx(M,{disabled:!0,children:"No departments found"})]})]}),e.jsxs(z,{size:"small",className:"md:w-[130px] w-[47%]",children:[e.jsx(F,{children:"Month"}),e.jsx(U,{value:o.month,label:"Month",onChange:s=>D("month",s.target.value),children:c.months().map((s,t)=>e.jsx(M,{value:t+1,children:s},t+1))})]}),e.jsxs(z,{size:"small",className:"md:w-[100px] w-[47%]",children:[e.jsx(F,{children:"Year"}),e.jsx(U,{value:o.year,label:"Year",onChange:s=>D("year",s.target.value),children:Array.from({length:5},(s,t)=>c().year()-2+t).map(s=>e.jsx(M,{value:s,children:s},s))})]})]}),e.jsx("div",{className:" w-full md:w-fit",children:e.jsx(he,{onClick:Y,className:"flex-1",variant:"outlined",startIcon:e.jsx(xe,{}),children:"Export"})})]}),e.jsxs("div",{className:"mt-4 bg-white rounded shadow p-1 md:p-3",children:[e.jsxs("div",{className:"text-xl relative font-semibold flex justify-between mb-5",children:[e.jsxs("p",{className:"text-gray-700",children:["Daily Attendance Report -"," ",c(`${o.year}-${o.month}-01`).format("MMMM YYYY")]}),e.jsxs("label",{className:"inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:b,onChange:()=>q(!b),className:"sr-only peer"}),e.jsx("div",{className:"w-12 h-6 bg-gray-200 rounded-full peer-checked:bg-blue-600 relative transition-colors"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:b?"Light Theme":"Dark Theme"})]})]}),e.jsx(be,{csvcall:G,filters:o,setcsvcall:O,theme:b})]})]})};export{pe as default};
