import{f as A,r as a,a as U,u as G,g as i,j as e,C as w,A as b,F as y,y as O,v as D}from"./index-BibUWqKW.js";import{D as H}from"./dashboardCard-9RrEEQ3g.js";import{F as C,I as F,S as z,O as P}from"./Select-BTOMxnCG.js";import{M as u}from"./MenuItem-BWos4OdY.js";import{I as k}from"./InputAdornment-XtuWsZQQ.js";import{T as K}from"./Tooltip-B96yZl5F.js";import"./createSimplePaletteValueFilter-fo0FgVSD.js";import"./useSlotProps-DEnoR5oY.js";import"./ButtonBase-CpdL3qg7.js";import"./Typography-BmLnLqOh.js";import"./Popper-CLFBLgri.js";const ie=()=>{var E,_;const{attandence:o,employee:m,branch:p,department:h,profile:f}=A(s=>s.user),{islogin:T,isadmin:Q}=A(s=>s.auth),[N,M]=a.useState([]),[I,R]=a.useState([]);let $=U();const v=G(),q=a.useRef(o),[d,B]=a.useState("all"),[x,S]=a.useState("all"),[g,J]=a.useState([]),[V,L]=a.useState([]);return a.useEffect(()=>{!T&&$("/login")},[]),a.useEffect(()=>{if(!m||m.length===0)return;const s=m.filter(l=>{const t=d==="all"||l.branchId===d,r=x==="all"||l.department._id===x;return t&&r});J(s)},[d,x,m]),a.useEffect(()=>{S("all")},[d]),a.useEffect(()=>{L()},[p]),a.useEffect(()=>{q.current=o},[o]),a.useEffect(()=>{if(!o)return;let s=o.filter(t=>i(t.date).isSame(i(),"day")&&!t.punchOut),l=o.filter(t=>i(t.date).isSame(i(),"day"));M(s),R(l)},[o]),a.useEffect(()=>{let s=null,l=1e3,t=1e4,r=null;return(()=>{r=new EventSource("/events"),r.onopen=()=>{console.log("✅ SSE connection established successfully"),l=1e3},r.onmessage=j=>{try{const c=JSON.parse(j.data);if(c.type==="attendance_update"){console.log(c.payload.action,c.payload.data);let n=c.payload.data;c.payload.action==="checkin"&&(O(e.jsxs("div",{className:"flex items-center gap-2 pr-1",children:[e.jsx(b,{src:n.employeeId.profileimage,alt:n.employeeId.employeename,children:!n.employeeId.profileimage&&e.jsx(y,{})}),e.jsxs("span",{className:"text-[14px] ",children:[e.jsxs("span",{className:"text-green-700 capitalize font-semibold",children:[" ",n.employeeId.userid.name]})," has Punched In at"," ",e.jsxs("span",{className:"text-green-700 ",children:[" ",i(n.punchIn).format("hh:mm A")]})]})]}),{autoClose:2e4}),v(D())),c.payload.action==="checkOut"&&(O(e.jsxs("div",{className:"flex items-center gap-2 pr-1",children:[e.jsx(b,{src:n.employeeId.profileimage,alt:n.employeeId.employeename,children:!n.employeeId.profileimage&&e.jsx(y,{})}),e.jsxs("span",{className:"text-[14px] ",children:[e.jsxs("span",{className:"text-amber-700 capitalize font-semibold ",children:[" ",n.employeeId.userid.name]})," has Punched Out at"," ",e.jsxs("span",{className:"text-amber-700 ",children:[" ",i(n.punchOut).format("hh:mm A")]})]})]}),{autoClose:2e4}),v(D()))}}catch(c){console.error("Failed to parse SSE message:",c)}},r.onerror=j=>{console.warn("SSE connection lost, retrying...",j),r.close(),s=setTimeout(()=>{l=Math.min(l*2,t)},l)}})(),()=>{r&&r.close(),s&&clearTimeout(s)}},[]),e.jsxs("div",{className:"p-0  md:p-3",children:[e.jsx("div",{className:"mb-3",children:e.jsx(H,{employee:m,todaypresent:I.length,currentpresent:N.length})}),e.jsxs("div",{className:"w-full flex-col flex gap-5 shadow  bg-white p-2 rounded",children:[e.jsxs("div",{className:"flex gap-3 pt-3",children:[e.jsxs(C,{sx:{width:"160px"},required:!0,size:"small",children:[e.jsx(F,{id:"demo-simple-select-helper-label",children:"Branch"}),e.jsxs(z,{value:d,input:e.jsx(P,{startAdornment:e.jsx(k,{position:"start",children:e.jsx(w,{fontSize:"small"})}),label:"branch"}),onChange:s=>B(s.target.value),children:[e.jsx(u,{selected:!0,value:"all",children:"All"}),(E=p==null?void 0:p.filter(s=>f==null?void 0:f.branchIds.includes(s._id)))==null?void 0:E.map(s=>e.jsx(u,{value:s._id,children:s.name},s._id))]})]}),e.jsxs(C,{sx:{width:"160px"},required:!0,size:"small",children:[e.jsx(F,{id:"demo-simple-select-helper-label",children:"Department"}),e.jsxs(z,{disabled:d=="all",value:x,input:e.jsx(P,{startAdornment:e.jsx(k,{position:"start",children:e.jsx(w,{fontSize:"small"})}),label:"Department"}),onChange:s=>S(s.target.value),children:[e.jsx(u,{selected:!0,value:"all",children:"All"}),(_=h==null?void 0:h.filter(s=>s.branchId._id==d))==null?void 0:_.map(s=>e.jsx(u,{value:s._id,children:s.department},s._id))]})]})]}),e.jsx("div",{className:"grid grid-cols-5 md:grid-cols-10 lg:grid-cols-15 gap-2 md:gap-4",children:g==null?void 0:g.map(s=>{const l=N.some(r=>r.employeeId._id===s._id),t=I.find(r=>r.employeeId._id===s._id);return e.jsx(K,{arrow:!0,enterDelay:800,placement:"top",title:e.jsxs("div",{className:"flex flex-col ",children:[e.jsxs("span",{children:[" In       ",t!=null&&t.punchIn?i(t.punchIn).format("hh:mm A"):" -:-"]}),e.jsxs("span",{children:[" Out    ",t!=null&&t.punchOut?i(t.punchOut).format("hh:mm A"):"-:-"]})]}),children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`${t?l?"border-green-500":"border-amber-400":"border-gray-300"} p-[2px] border-3 rounded-full`,children:e.jsx(b,{src:s.profileimage,alt:s.employeename,children:!s.profileimage&&e.jsx(y,{})})}),e.jsx("p",{className:`${t?l?"text-green-600 text-[14px]":"text-amber-700":"text-gray-500"} text-[12px] text-center transition-all duration-300 capitalize `,children:s.userid.name})]},s._id)},s._id)})}),e.jsxs("div",{className:"flex gap-5",children:[e.jsxs("span",{className:"flex items-center gap-1 text-green-500 text-[13px] ",children:[e.jsx("span",{className:"block w-[15px] rounded-3xl h-[15px] bg-green-500 "})," In Premise"]}),e.jsxs("span",{className:"flex items-center gap-1 text-amber-700 text-[13px]",children:[e.jsx("span",{className:"block w-[15px] rounded-3xl h-[15px] bg-amber-500 "})," Present"]}),e.jsxs("span",{className:"flex items-center gap-1 text-gray-500 text-[13px]",children:[e.jsx("span",{className:"block w-[15px] rounded-3xl h-[15px] bg-gray-500  "})," Absent"]})]})]})]})};export{ie as default};
