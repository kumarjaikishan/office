import{aU as Re,r,g as Ye,h as v,j as e,T as b,F as H,I as G,S as K,M as T,A as _e,k as We,b as h,a5 as ne,ak as oe,B as Q,c as Ue,y as we}from"./index-Cc-EAZBW.js";import{b as re}from"./index-DDaB1Z54.js";import{i as Je}from"./isSameOrBefore-JklG_Aau.js";import{i as qe}from"./isBetween-nbO_DIHa.js";import{l as He}from"./localeData-9T7s1ian.js";import{n as Ge}from"./numToWord-bs75z5E6.js";import{C as k,D}from"./Divider-C-pV4y98.js";import{F}from"./FormControlLabel-BtbUGwO7.js";import{C as $}from"./Checkbox-BRxn3Bpl.js";import"./SwitchBase-ScAZkevN.js";v.extend(He);v.extend(qe);v.extend(Je);function oa(){var je,ye,be;const{employeeId:Ne}=Re(),[V,Ae]=r.useState([]),[M,Se]=r.useState(Ne||""),[o,Ce]=r.useState(null),[P,ke]=r.useState(0),[g,Me]=r.useState(0),[Ie,Oe]=r.useState([]),[X,Ke]=r.useState(0),[A,Be]=r.useState(0),[S,Pe]=r.useState(0),{holidays:C,company:i,employee:ie,attandence:Z,leaveBalance:ee,advance:ae}=Ye(a=>a.user),[de,ce]=r.useState(!1),[me,ue]=r.useState(null),[xe,he]=r.useState(null);r.useEffect(()=>{var s;if(!o||!ee)return;const a=(s=ee.filter(t=>{var m,c,f;return((c=(m=t.employeeId)==null?void 0:m._id)==null?void 0:c.toString())===((f=o._id)==null?void 0:f.toString())}).slice().sort((t,m)=>new Date(m.date)-new Date(t.date)))==null?void 0:s[0];Be((a==null?void 0:a.balance)||0)},[ee,o]),r.useEffect(()=>{var s;if(!o||!ae)return;const a=(s=ae.filter(t=>{var m,c,f;return((c=(m=t.employeeId)==null?void 0:m._id)==null?void 0:c.toString())===((f=o._id)==null?void 0:f.toString())}).slice().sort((t,m)=>new Date(m.date)-new Date(t.date)))==null?void 0:s[0];Pe(a==null?void 0:a.balance)},[ae,o]);function p(a){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(a)}const[l,N]=r.useState({month:new Date().getMonth()+1,year:new Date().getFullYear(),calculationBasis:"monthDays",allowances:[],bonuses:[],deductions:[],leaveDays:0,absentDays:0,presentDays:0,paidDays:0,adjustPaidLeave:!1}),[d,ze]=r.useState({totalDays:0,holidaysCount:0,weeklyOff:0,workingDays:0,overtime:0,shortmin:0}),fe={addOvertime:!1,deductShortTime:!1,deductAbsent:!1,adjustLeave:!1,adjustAdvance:!1,adjustedLeaveCount:0,adjustedAdvance:0},[x,y]=r.useState(fe),Le=["January","February","March","April","May","June","July","August","September","October","November","December"];r.useEffect(()=>{Ae(ie||[])},[ie]),r.useEffect(()=>{if(!o||!(d!=null&&d.totalDays)||!(i!=null&&i.workingMinutes))return;let a=l.calculationBasis==="monthDays"?d.totalDays||1:d.totalDays-(d.holidaysCount+d.weeklyOff)||1;const s=o.salary/a,t=s/i.workingMinutes.fullDay;ke(t.toFixed(2)),Me(s.toFixed(2))},[l.calculationBasis,d,o,i]),r.useEffect(()=>{if(!C)return;const a=[];C.forEach(s=>{let t=v(s.fromDate);const m=s.toDate?v(s.toDate):t;for(;t.isSameOrBefore(m,"day");)a.push(t.format("DD/MM/YYYY")),t=t.add(1,"day")}),Oe(a)},[C]),r.useEffect(()=>{var B;if(!Z||!M)return;const a=V.find(u=>u._id===M);y(fe),Ce(a);const s=v(`${l.year}-${String(l.month).padStart(2,"0")}-01`),t=s.isSame(v(),"month"),c=s.endOf("month").date(),f=Z.filter(u=>u.employeeId._id===M&&v(u.date).isSame(s,"month")),{present:L,absent:_,leaves:W,overtime:U,shortmin:J}=f.reduce((u,j)=>{var De,ge;j.status==="present"&&u.present++,j.status==="absent"&&u.absent++,j.status==="leave"&&u.leaves++;const le=v(j.date).format("DD/MM/YYYY"),{workingMinutes:w}=j,q=v(j.date).startOf("day").day(),$e=Ie.includes(le),Ee=i==null?void 0:i.weeklyOffs.includes(q);return $e||Ee?u.overtime+=w:j.status==="present"&&(w<((De=i==null?void 0:i.workingMinutes)==null?void 0:De.shortDayThreshold)?u.shortmin+=i.workingMinutes.shortDayThreshold-w:w>((ge=i==null?void 0:i.workingMinutes)==null?void 0:ge.overtimeAfterMinutes)&&(u.overtime+=w-i.workingMinutes.overtimeAfterMinutes)),u},{present:0,absent:0,leaves:0,overtime:0,shortmin:0});N(u=>({...u,leaveDays:W,absentDays:_,presentDays:L,paidDays:L}));let O=0;for(let u=1;u<=c;u++){const j=s.date(u);(B=i==null?void 0:i.weeklyOffs)!=null&&B.includes(j.day())&&O++}let n=0;C==null||C.forEach(u=>{const j=v(u.fromDate),le=v(u.toDate);for(let w=1;w<=c;w++){const q=s.date(w);if(t&&q.isAfter(v(),"day"))break;q.isBetween(j,le,"day","[]")&&n++}}),ze({totalDays:c,workingDays:c-(O+n),weeklyOff:O,holidaysCount:n,overtime:U,shortmin:J})},[M,Z,l.month,l.year,V,i,C]);const ve=r.useMemo(()=>l.adjustPaidLeave?Math.max(l.leaveDays-A,0):l.leaveDays,[l.leaveDays,l.adjustPaidLeave,A]),Te=r.useMemo(()=>ve*g,[ve,g]),E=r.useMemo(()=>l.allowances.reduce((a,s)=>a+Number(s.amount),0),[l.allowances]),R=r.useMemo(()=>l.bonuses.reduce((a,s)=>a+Number(s.amount),0),[l.bonuses]),Y=r.useMemo(()=>l.deductions.reduce((a,s)=>a+Number(s.amount),0),[l.deductions,Te]),z=r.useMemo(()=>(o==null?void 0:o.salary)+E+R,[g,l.paidDays,E,R]);r.useMemo(()=>(z*X/100).toFixed(2),[z,X]),r.useCallback(a=>{const s=Math.floor(a/60),t=a%60;return`${s}h ${t}m`},[]);const pe=r.useMemo(()=>Math.floor(z-Y),[z,Y]),I=(a,s,t,m)=>{const c=[...l[a]];c[s][t]=m,N(f=>({...f,[a]:c}))};r.useEffect(()=>{var m,c,f,L,_,W,U,J,O;if(!o)return;let a={...l};o!=null&&o.defaultPolicies?(a.allowances=((m=o.allowances)==null?void 0:m.map(n=>({name:n.name,amount:n.value,extraInfo:"",inputDisabled:!1})))||[],a.bonuses=((c=o.bonuses)==null?void 0:c.map(n=>({name:n.name,amount:n.value,extraInfo:"",inputDisabled:!1})))||[],a.deductions=((f=o.deductions)==null?void 0:f.map(n=>({name:n.name,amount:n.value,extraInfo:"",inputDisabled:!1})))||[]):i!=null&&i.payrollPolicies&&(a.allowances=((_=(L=i.payrollPolicies)==null?void 0:L.allowances)==null?void 0:_.map(n=>({name:n.name,amount:n.value,extraInfo:"",inputDisabled:!1})))||[],a.bonuses=((U=(W=i.payrollPolicies)==null?void 0:W.bonuses)==null?void 0:U.map(n=>({name:n.name,amount:n.value,extraInfo:"",inputDisabled:!1})))||[],a.deductions=((O=(J=i.payrollPolicies)==null?void 0:J.deductions)==null?void 0:O.map(n=>({name:n.name,amount:n.value,extraInfo:"",inputDisabled:!1})))||[]);let s=[...a.bonuses],t=[...a.deductions];if(s=s.filter(n=>n.name!=="Overtime"),x.addOvertime){const n=d.overtime*P;s.push({name:"Overtime",amount:n.toFixed(2),extraInfo:`${d.overtime} Min @ ₹${P} per min.`,inputDisabled:!0})}if(t=t.filter(n=>n.name!=="Short Time"),x.deductShortTime&&d.shortmin>0){const n=d.shortmin*P;t.push({name:"Short Time",amount:n.toFixed(2),extraInfo:`${d.shortmin} min @ ₹${P} per min.`,inputDisabled:!0})}if(t=t.filter(n=>n.name!=="Absent"),x.deductAbsent&&l.absentDays>0&&t.push({name:"Absent",amount:(l.absentDays*g).toFixed(2),extraInfo:`${l.absentDays} Absent @ ₹${g} per day`,inputDisabled:!0}),t=t.filter(n=>n.name!=="Advance"),x.adjustAdvance&&S>0){let n=S-x.adjustedAdvance;t.push({name:"Advance",amount:x.adjustedAdvance.toFixed(2),extraInfo:`Adjusted :${x.adjustedAdvance},  Remaining :${n}`,inputDisabled:!0})}if(t=t.filter(n=>n.name!=="Paid Leave Adjustment"&&n.name!=="Unpaid Leave"),x.adjustLeave&&l.leaveDays>0){const n=Math.min(x.adjustedLeaveCount,A,l.leaveDays),B=l.leaveDays-n;n>0&&t.push({name:"Paid Leave Adjustment",amount:0,extraInfo:`${n} Leaves adjusted, Remaining Leaves: ${A-n}`,inputDisabled:!0}),B>0&&t.push({name:"Unpaid Leave",amount:(B*g).toFixed(2),extraInfo:`${B} leaves @ ${g}`,inputDisabled:!0})}a.bonuses=s,a.deductions=t,N(a)},[x,g,o]);const se=(a,s)=>N(t=>({...t,[a]:[...t[a],s]})),te=(a,s)=>N(t=>{const m=[...t[a]];return m.splice(s,1),{...t,[a]:m}}),Fe=async()=>{var s,t,m;const a={employeeId:o._id,calculationBasis:l.calculationBasis,options:x,basic:d,month:l.month,year:l.year,present:l.presentDays,leave:l.leaveDays,absent:l.absentDays,allowances:l.allowances,bonuses:l.bonuses,deductions:l.deductions,taxRate:X,name:(s=o==null?void 0:o.userid)==null?void 0:s.name};try{ce(!0),he(null),ue(null);const c=localStorage.getItem("emstoken"),f=await Ue.post("/api/payroll",{...a},{headers:{Authorization:`Bearer ${c}`}});console.log(f),we.success(f.data.message),ue("Payroll created successfully!")}catch(c){console.log(c),c.response?(he(((m=(t=c.response)==null?void 0:t.data)==null?void 0:m.message)||"Failed to create payroll"),we.warn(c.response.data.message,{autoClose:1200})):c.request?console.error("No response from server:",c.request):console.error("Error:",c.message)}finally{ce(!1)}};return e.jsxs("div",{className:"max-w-full gap-4 grid grid-cols-2 mx-auto p-0 md:p-6 space-y-1",children:[e.jsxs(k,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Select Employee"}),e.jsx(D,{}),e.jsxs("div",{className:"grid gap-2 md:gap-4 grid-cols-2 mt-4 space-y-1",children:[e.jsxs(H,{size:"small",children:[e.jsx(G,{children:"Month"}),e.jsx(K,{label:"Month",value:l.month,onChange:a=>N(s=>({...s,month:a.target.value})),children:Le.map((a,s)=>e.jsx(T,{value:s+1,children:a},s))})]}),e.jsxs(H,{size:"small",children:[e.jsx(G,{children:"Year"}),e.jsx(K,{label:"year",value:l.year,onChange:a=>N(s=>({...s,year:a.target.value})),children:["2024","2025","2026"].map(a=>e.jsx(T,{value:a,children:a},a))})]}),e.jsxs(H,{size:"small",children:[e.jsx(G,{children:"Calc. Basis"}),e.jsxs(K,{label:"Calc. Basis",value:l.calculationBasis,onChange:a=>N(s=>({...s,calculationBasis:a.target.value})),children:[e.jsx(T,{value:"monthDays",children:"Month Days"}),e.jsx(T,{value:"workingDays",children:"Working Days"})]})]}),e.jsxs(H,{disabled:!l.month||!l.year,className:"col-span-1",size:"small",children:[e.jsx(G,{children:"Select Employee"}),e.jsx(K,{label:"Select Employee",value:M,onChange:a=>Se(a.target.value),children:V.map(a=>{var s;return e.jsx(T,{value:a._id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{src:We(a==null?void 0:a.profileimage,{format:"webp",width:100,height:100}),sx:{width:24,height:24}}),(s=a.userid)==null?void 0:s.name]})},a._id)})})]})]})]}),o&&e.jsxs(k,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Attendance Summary"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col  gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(h,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Total Days",value:d.totalDays}),e.jsx(h,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Holidays",value:d.holidaysCount}),e.jsx(h,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Weekly Offs",value:d.weeklyOff}),e.jsx(h,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Working Days",value:d.workingDays}),e.jsx(h,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Present Days",value:l.presentDays||0}),e.jsx(h,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Leave Days",value:l.leaveDays||0}),e.jsx(h,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Absent Days",value:l.absentDays||0})]}),e.jsx(D,{}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(h,{size:"small",label:"OverTime Minutes",value:d.overtime||0}),e.jsx(h,{size:"small",label:"ShortTime Minutes",value:d.shortmin||0}),e.jsx(h,{size:"small",label:"Per day Salary",value:p(g),helperText:"For Leave/ Absent Calculations"}),e.jsx(h,{size:"small",label:"Per minute Salary",value:p(P),helperText:"For OverTime/ ShortTime Calculations"})]})]})]}),o&&e.jsxs(k,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Adjustments"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col gap-2 mt-4",children:[d!=null&&d.overtime?e.jsx(F,{control:e.jsx($,{checked:x.addOvertime,onChange:a=>y(s=>({...s,addOvertime:a.target.checked}))}),label:"Add Overtime as Bonus"}):"",d!=null&&d.shortmin?e.jsx(F,{control:e.jsx($,{checked:x.deductShortTime,onChange:a=>y(s=>({...s,deductShortTime:a.target.checked}))}),label:"Deduct Short Time"}):"",l!=null&&l.absentDays?e.jsx(F,{control:e.jsx($,{checked:x.deductAbsent,onChange:a=>y(s=>({...s,deductAbsent:a.target.checked}))}),label:"Deduct Absent Days"}):"",l!=null&&l.leaveDays?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(F,{control:e.jsx($,{checked:x.adjustLeave,onChange:a=>y(s=>({...s,adjustLeave:a.target.checked}))}),label:"Adjust Paid Leaves"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Available Paid leaves: ",A]}),x.adjustLeave&&e.jsx(h,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Count",inputProps:{min:0,max:Math.min(A,l.leaveDays)},value:x.adjustedLeaveCount,onChange:a=>{const s=Number(a.target.value),t=Math.min(A,l.leaveDays);y(m=>({...m,adjustedLeaveCount:Math.max(0,Math.min(s,t))}))}})]}):"",S>0?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(F,{control:e.jsx($,{checked:x.adjustAdvance,onChange:a=>y(s=>({...s,adjustAdvance:a.target.checked}))}),label:"Adjust Advance"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Advance: ",S]}),x.adjustAdvance&&e.jsx(h,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Advance",inputProps:{min:0,max:S},value:x.adjustedAdvance,onChange:a=>{const s=Number(a.target.value);s<0?y(t=>({...t,adjustedAdvance:0})):s>S?y(t=>({...t,adjustedAdvance:S})):y(t=>({...t,adjustedAdvance:s}))}})]}):""]})]}),o&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Allowances"}),e.jsx(b,{variant:"h6",children:p(E)})]}),e.jsx(D,{}),(je=l==null?void 0:l.allowances)==null?void 0:je.map((a,s)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(h,{size:"small",label:"Name",className:"flex-5",value:a.name,onChange:t=>I("allowances",s,"name",t.target.value)}),e.jsx(h,{size:"small",type:"number",label:"Amount",className:"flex-2",InputProps:{readOnly:a.inputDisabled||!1},value:a.amount,onChange:t=>I("allowances",s,"amount",t.target.value)}),e.jsx(ne,{onClick:()=>te("allowances",s),children:e.jsx(oe,{})})]},s)),e.jsx(Q,{startIcon:e.jsx(re,{}),variant:"outlined",onClick:()=>se("allowances",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2 flex-1",children:"Add Allowance"})]}),o&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Bonuses"}),e.jsx(b,{variant:"h6",children:p(R)})]}),e.jsx(D,{}),(ye=l==null?void 0:l.bonuses)==null?void 0:ye.map((a,s)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(h,{size:"small",label:"Name",className:"flex-5",value:a.name,helperText:a.extraInfo??"",onChange:t=>I("bonuses",s,"name",t.target.value)}),e.jsx(h,{size:"small",type:"number",label:"Amount",InputProps:{readOnly:a.inputDisabled||!1},className:"flex-2",value:a.amount,onChange:t=>I("bonuses",s,"amount",t.target.value)}),e.jsx(ne,{className:"flex-1",onClick:()=>te("bonuses",s),children:e.jsx(oe,{})})]},s)),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(re,{}),onClick:()=>se("bonuses",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Bonus"})]}),o&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(b,{variant:"h6",children:"Deductions"}),e.jsx(b,{variant:"h6",children:p(Y)})]}),e.jsx(D,{}),(be=l==null?void 0:l.deductions)==null?void 0:be.map((a,s)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(h,{size:"small",label:"Deduction",className:"flex-5",value:a.name,helperText:a.extraInfo??"",onChange:t=>I("deductions",s,"name",t.target.value)}),e.jsx(h,{size:"small",type:"number",className:"flex-2",label:"Amount",InputProps:{readOnly:(a==null?void 0:a.inputDisabled)||!1},value:a.amount,onChange:t=>I("deductions",s,"amount",t.target.value)}),e.jsx(ne,{className:"flex-1",onClick:()=>te("deductions",s),children:e.jsx(oe,{})})]},s)),e.jsx(Q,{variant:"outlined",startIcon:e.jsx(re,{}),onClick:()=>se("deductions",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Deduction"})]}),o&&e.jsxs(k,{className:"shadow-md col-span-2 md:col-span-1 p-4 rounded-2xl",children:[e.jsx(b,{variant:"h6",children:"Salary Summary"}),e.jsx(D,{}),e.jsxs("div",{className:"flex flex-col gap-2 text-right mt-3",children:[e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Base Salary :"}),e.jsx("div",{className:"w-[100px] font-semibold",children:p((o==null?void 0:o.salary)||0)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Allowances :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",p(E)]})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Bonuses :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",p(R)]})]}),e.jsx(D,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:"Gross Salary :"}),e.jsx("div",{className:"w-[100px]",children:p(z)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Deductions :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["-",p(Y)," "]})]}),e.jsx(D,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:" Net Salary "}),e.jsx("div",{className:"w-[100px]",children:p(pe)})]}),e.jsxs("div",{className:"capitalize text-xs",children:[" In Words:- ",Ge(pe)," "]})]})]}),o&&e.jsx("div",{className:"col-span-2",children:e.jsx(Q,{variant:"contained",color:"primary",onClick:Fe,disabled:de||!M,children:de?"Saving...":"Save Payroll"})}),me&&e.jsx("p",{className:"text-green-600 mt-2",children:me}),xe&&e.jsx("p",{className:"text-red-600 mt-2",children:xe})]})}export{oa as default};
