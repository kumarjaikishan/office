import{aO as Fe,r as n,g as Ee,h,j as e,T as y,F as $,I as R,S as Y,M as B,A as $e,b as x,X as Z,af as ee,B as _,c as Re,y as ve}from"./index-DBKpBzGg.js";import{b as ae}from"./index-ZEQGb_Gi.js";import{i as Ye}from"./isSameOrBefore-Ev9ifRN6.js";import{i as _e}from"./isBetween-CV5sI2yP.js";import{l as We}from"./localeData-BuW5l9iV.js";import{n as He}from"./numToWord-bs75z5E6.js";import{C,D as b}from"./Divider-BbHmoo4s.js";import{F as z}from"./FormControlLabel-jkGCcnqf.js";import{C as L}from"./Checkbox-B7zxLVti.js";h.extend(We);h.extend(_e);h.extend(Ye);function aa(){const{employeeId:pe}=Fe(),[W,je]=n.useState([]),[k,ye]=n.useState(pe||""),[o,be]=n.useState(null),[I,De]=n.useState(0),[D,ge]=n.useState(0),[we,Ne]=n.useState([]),[H,Je]=n.useState(0),[N,Ae]=n.useState(0),[A,Se]=n.useState(0),{holidays:S,company:m,employee:se,attandence:J,leaveBalance:q,advance:U}=Ee(s=>s.user),[te,le]=n.useState(!1),[ne,re]=n.useState(null),[oe,de]=n.useState(null);n.useEffect(()=>{var a;if(!o||!q)return;const s=(a=q.filter(t=>{var d,i,f;return((i=(d=t.employeeId)==null?void 0:d._id)==null?void 0:i.toString())===((f=o._id)==null?void 0:f.toString())}).slice().sort((t,d)=>new Date(d.date)-new Date(t.date)))==null?void 0:a[0];Ae((s==null?void 0:s.balance)||0)},[q,o]),n.useEffect(()=>{var a;if(!o||!U)return;const s=(a=U.filter(t=>{var d,i,f;return((i=(d=t.employeeId)==null?void 0:d._id)==null?void 0:i.toString())===((f=o._id)==null?void 0:f.toString())}).slice().sort((t,d)=>new Date(d.date)-new Date(t.date)))==null?void 0:a[0];Se(s==null?void 0:s.balance)},[U,o]);function v(s){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(s)}const[l,w]=n.useState({month:new Date().getMonth()+1,year:new Date().getFullYear(),calculationBasis:"monthDays",allowances:[{name:"HRA",amount:0,extraInfo:"",inputDisabled:!1}],bonuses:[{name:"Performance",amount:0,extraInfo:"",inputDisabled:!1}],deductions:[{name:"PF",amount:0,extraInfo:"",inputDisabled:!1}],leaveDays:0,absentDays:0,presentDays:0,paidDays:0,adjustPaidLeave:!1}),[r,Ce]=n.useState({totalDays:0,holidaysCount:0,weeklyOff:0,workingDays:0,overtime:0,shortmin:0}),ie={addOvertime:!1,deductShortTime:!1,deductAbsent:!1,adjustLeave:!1,adjustAdvance:!1,adjustedLeaveCount:0,adjustedAdvance:0},[u,j]=n.useState(ie),ke=["January","February","March","April","May","June","July","August","September","October","November","December"];n.useEffect(()=>{je(se||[])},[se]),n.useEffect(()=>{if(!o||!(r!=null&&r.totalDays)||!(m!=null&&m.workingMinutes))return;let s=l.calculationBasis==="monthDays"?r.totalDays||1:r.totalDays-(r.holidaysCount+r.weeklyOff)||1;const a=o.salary/s,t=a/m.workingMinutes.fullDay;De(t.toFixed(2)),ge(a.toFixed(2))},[l.calculationBasis,r,o,m]),n.useEffect(()=>{if(!S)return;const s=[];S.forEach(a=>{let t=h(a.fromDate);const d=a.toDate?h(a.toDate):t;for(;t.isSameOrBefore(d,"day");)s.push(t.format("DD/MM/YYYY")),t=t.add(1,"day")}),Ne(s)},[S]),n.useEffect(()=>{var xe;if(!J||!k)return;const s=W.find(c=>c._id===k);j(ie),be(s);const a=h(`${l.year}-${String(l.month).padStart(2,"0")}-01`),t=a.isSame(h(),"month"),i=a.endOf("month").date(),f=J.filter(c=>c.employeeId._id===k&&h(c.date).isSame(a,"month")),{present:ue,absent:Oe,leaves:Be,overtime:ze,shortmin:Le}=f.reduce((c,p)=>{var he,fe;p.status==="present"&&c.present++,p.status==="absent"&&c.absent++,p.status==="leave"&&c.leaves++;const V=h(p.date).format("DD/MM/YYYY"),{workingMinutes:g}=p,E=h(p.date).startOf("day").day(),Pe=we.includes(V),Te=m==null?void 0:m.weeklyOffs.includes(E);return Pe||Te?c.overtime+=g:p.status==="present"&&(g<((he=m==null?void 0:m.workingMinutes)==null?void 0:he.shortDayThreshold)?c.shortmin+=m.workingMinutes.shortDayThreshold-g:g>((fe=m==null?void 0:m.workingMinutes)==null?void 0:fe.overtimeAfterMinutes)&&(c.overtime+=g-m.workingMinutes.overtimeAfterMinutes)),c},{present:0,absent:0,leaves:0,overtime:0,shortmin:0});w(c=>({...c,leaveDays:Be,absentDays:Oe,presentDays:ue,paidDays:ue}));let K=0;for(let c=1;c<=i;c++){const p=a.date(c);(xe=m==null?void 0:m.weeklyOffs)!=null&&xe.includes(p.day())&&K++}let Q=0;S==null||S.forEach(c=>{const p=h(c.fromDate),V=h(c.toDate);for(let g=1;g<=i;g++){const E=a.date(g);if(t&&E.isAfter(h(),"day"))break;E.isBetween(p,V,"day","[]")&&Q++}}),Ce({totalDays:i,workingDays:i-(K+Q),weeklyOff:K,holidaysCount:Q,overtime:ze,shortmin:Le})},[k,J,l.month,l.year,W,m,S]);const ce=n.useMemo(()=>l.adjustPaidLeave?Math.max(l.leaveDays-N,0):l.leaveDays,[l.leaveDays,l.adjustPaidLeave,N]),Me=n.useMemo(()=>ce*D,[ce,D]),P=n.useMemo(()=>l.allowances.reduce((s,a)=>s+Number(a.amount),0),[l.allowances]),T=n.useMemo(()=>l.bonuses.reduce((s,a)=>s+Number(a.amount),0),[l.bonuses]),F=n.useMemo(()=>l.deductions.reduce((s,a)=>s+Number(a.amount),0),[l.deductions,Me]),O=n.useMemo(()=>(o==null?void 0:o.salary)+P+T,[D,l.paidDays,P,T]);n.useMemo(()=>(O*H/100).toFixed(2),[O,H]),n.useCallback(s=>{const a=Math.floor(s/60),t=s%60;return`${a}h ${t}m`},[]);const me=n.useMemo(()=>Math.floor(O-F),[O,F]),M=(s,a,t,d)=>{const i=[...l[s]];i[a][t]=d,w(f=>({...f,[s]:i}))};n.useEffect(()=>{let s=[...l.bonuses],a=[...l.deductions];if(s=s.filter(t=>t.name!=="Overtime"),u.addOvertime){const t=r.overtime*I;s.push({name:"Overtime",amount:t.toFixed(2),extraInfo:`${r.overtime} Min @ ₹${I} per min.`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Short Time"),u.deductShortTime&&r.shortmin>0){const t=r.shortmin*I;a.push({name:"Short Time",amount:t.toFixed(2),extraInfo:`${r.shortmin} min @ ₹${I} per min.`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Absent"),u.deductAbsent&&l.absentDays>0&&a.push({name:"Absent",amount:(l.absentDays*D).toFixed(2),extraInfo:`${l.absentDays} Absent @ ₹${D} per day`,inputDisabled:!0}),a=a.filter(t=>t.name!=="Advance"),u.adjustAdvance&&A>0){let t=A-u.adjustedAdvance;a.push({name:"Advance",amount:u.adjustedAdvance.toFixed(2),extraInfo:`Adjusted :${u.adjustedAdvance},  Remaining :${t}`,inputDisabled:!0})}if(a=a.filter(t=>t.name!=="Paid Leave Adjustment"&&t.name!=="Unpaid Leave"),u.adjustLeave&&l.leaveDays>0){const t=Math.min(u.adjustedLeaveCount,N,l.leaveDays),d=l.leaveDays-t;t>0&&a.push({name:"Paid Leave Adjustment",amount:0,extraInfo:`${t} Leaves adjusted, Remaining Leaves: ${N-t}`,inputDisabled:!0}),d>0&&a.push({name:"Unpaid Leave",amount:(d*D).toFixed(2),extraInfo:`${d} leaves @ ${D}`,inputDisabled:!0})}w(t=>({...t,bonuses:s,deductions:a}))},[u,D,l.leaveDays,l.absentDays,r.shortmin]);const G=(s,a)=>w(t=>({...t,[s]:[...t[s],a]})),X=(s,a)=>w(t=>{const d=[...t[s]];return d.splice(a,1),{...t,[s]:d}}),Ie=async()=>{var a,t,d;const s={employeeId:o._id,calculationBasis:l.calculationBasis,options:u,basic:r,month:l.month,year:l.year,present:l.presentDays,leave:l.leaveDays,absent:l.absentDays,allowances:l.allowances,bonuses:l.bonuses,deductions:l.deductions,taxRate:H,name:(a=o==null?void 0:o.userid)==null?void 0:a.name};try{le(!0),de(null),re(null);const i=localStorage.getItem("emstoken"),f=await Re.post("/api/payroll",{...s},{headers:{Authorization:`Bearer ${i}`}});console.log(f),ve.success(f.data.message),re("Payroll created successfully!")}catch(i){console.log(i),i.response?(de(((d=(t=i.response)==null?void 0:t.data)==null?void 0:d.message)||"Failed to create payroll"),ve.warn(i.response.data.message,{autoClose:1200})):i.request?console.error("No response from server:",i.request):console.error("Error:",i.message)}finally{le(!1)}};return e.jsxs("div",{className:"max-w-full gap-4 grid grid-cols-2 mx-auto p-0 md:p-6 space-y-1",children:[e.jsxs(C,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Select Employee"}),e.jsx(b,{}),e.jsxs("div",{className:"grid gap-2 md:gap-4 grid-cols-2 mt-4 space-y-1",children:[e.jsxs($,{size:"small",children:[e.jsx(R,{children:"Month"}),e.jsx(Y,{label:"Month",value:l.month,onChange:s=>w(a=>({...a,month:s.target.value})),children:ke.map((s,a)=>e.jsx(B,{value:a+1,children:s},a))})]}),e.jsxs($,{size:"small",children:[e.jsx(R,{children:"Year"}),e.jsx(Y,{label:"year",value:l.year,onChange:s=>w(a=>({...a,year:s.target.value})),children:["2024","2025","2026"].map(s=>e.jsx(B,{value:s,children:s},s))})]}),e.jsxs($,{size:"small",children:[e.jsx(R,{children:"Calc. Basis"}),e.jsxs(Y,{label:"Calc. Basis",value:l.calculationBasis,onChange:s=>w(a=>({...a,calculationBasis:s.target.value})),children:[e.jsx(B,{value:"monthDays",children:"Month Days"}),e.jsx(B,{value:"workingDays",children:"Working Days"})]})]}),e.jsxs($,{disabled:!l.month||!l.year,className:"col-span-1",size:"small",children:[e.jsx(R,{children:"Select Employee"}),e.jsx(Y,{label:"Select Employee",value:k,onChange:s=>ye(s.target.value),children:W.map(s=>{var a;return e.jsx(B,{value:s._id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($e,{src:s.profileimage,sx:{width:24,height:24}}),(a=s.userid)==null?void 0:a.name]})},s._id)})})]})]})]}),o&&e.jsxs(C,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(y,{variant:"h6",children:"Attendance Summary"}),e.jsx(b,{}),e.jsxs("div",{className:"flex flex-col  gap-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Total Days",value:r.totalDays}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Holidays",value:r.holidaysCount}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Weekly Offs",value:r.weeklyOff}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Working Days",value:r.workingDays}),e.jsx(x,{size:"small",className:"m max-w-full md:max-w-[120px]",label:"Present Days",value:l.presentDays||0}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Leave Days",value:l.leaveDays||0}),e.jsx(x,{className:"m max-w-full md:max-w-[120px]",size:"small",label:"Absent Days",value:l.absentDays||0})]}),e.jsx(b,{}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-4 text-sm md:flex md:flex-wrap",children:[e.jsx(x,{size:"small",label:"OverTime Minutes",value:r.overtime||0}),e.jsx(x,{size:"small",label:"ShortTime Minutes",value:r.shortmin||0}),e.jsx(x,{size:"small",label:"Per day Salary",value:v(D),helperText:"For Leave/ Absent Calculations"}),e.jsx(x,{size:"small",label:"Per minute Salary",value:v(I),helperText:"For OverTime/ ShortTime Calculations"})]})]})]}),o&&e.jsxs(C,{className:"shadow-md col-span-2 p-1 md:p-4 rounded-2xl",children:[e.jsx(y,{variant:"h6",children:"Adjustments"}),e.jsx(b,{}),e.jsxs("div",{className:"flex flex-col gap-2 mt-4",children:[r!=null&&r.overtime?e.jsx(z,{control:e.jsx(L,{checked:u.addOvertime,onChange:s=>j(a=>({...a,addOvertime:s.target.checked}))}),label:"Add Overtime as Bonus"}):"",r!=null&&r.shortmin?e.jsx(z,{control:e.jsx(L,{checked:u.deductShortTime,onChange:s=>j(a=>({...a,deductShortTime:s.target.checked}))}),label:"Deduct Short Time"}):"",l!=null&&l.absentDays?e.jsx(z,{control:e.jsx(L,{checked:u.deductAbsent,onChange:s=>j(a=>({...a,deductAbsent:s.target.checked}))}),label:"Deduct Absent Days"}):"",l!=null&&l.leaveDays?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(z,{control:e.jsx(L,{checked:u.adjustLeave,onChange:s=>j(a=>({...a,adjustLeave:s.target.checked}))}),label:"Adjust Paid Leaves"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Available Paid leaves: ",N]}),u.adjustLeave&&e.jsx(x,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Count",inputProps:{min:0,max:Math.min(N,l.leaveDays)},value:u.adjustedLeaveCount,onChange:s=>{const a=Number(s.target.value),t=Math.min(N,l.leaveDays);j(d=>({...d,adjustedLeaveCount:Math.max(0,Math.min(a,t))}))}})]}):"",A>0?e.jsxs("div",{className:"flex items-center flex-wrap md:border-none md:shadow-none border border-slate-300 shadow rounded md:p-0 p-1 gap-4",children:[e.jsx(z,{control:e.jsx(L,{checked:u.adjustAdvance,onChange:s=>j(a=>({...a,adjustAdvance:s.target.checked}))}),label:"Adjust Advance"}),e.jsxs("p",{className:"w-full md:w-fit",children:["Advance: ",A]}),u.adjustAdvance&&e.jsx(x,{type:"number",size:"small",className:"w-full md:w-[120px]",label:"Adjust Advance",inputProps:{min:0,max:A},value:u.adjustedAdvance,onChange:s=>{const a=Number(s.target.value);a<0?j(t=>({...t,adjustedAdvance:0})):a>A?j(t=>({...t,adjustedAdvance:A})):j(t=>({...t,adjustedAdvance:a}))}})]}):""]})]}),o&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(y,{variant:"h6",children:"Allowances"}),e.jsx(y,{variant:"h6",children:v(P)})]}),e.jsx(b,{}),l.allowances.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Name",className:"flex-5",value:s.name,onChange:t=>M("allowances",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",label:"Amount",className:"flex-2",InputProps:{readOnly:s.inputDisabled||!1},value:s.amount,onChange:t=>M("allowances",a,"amount",t.target.value)}),e.jsx(Z,{onClick:()=>X("allowances",a),children:e.jsx(ee,{})})]},a)),e.jsx(_,{startIcon:e.jsx(ae,{}),variant:"outlined",onClick:()=>G("allowances",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2 flex-1",children:"Add Allowance"})]}),o&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(y,{variant:"h6",children:"Bonuses"}),e.jsx(y,{variant:"h6",children:v(T)})]}),e.jsx(b,{}),l.bonuses.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Name",className:"flex-5",value:s.name,helperText:s.extraInfo??"",onChange:t=>M("bonuses",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",label:"Amount",InputProps:{readOnly:s.inputDisabled||!1},className:"flex-2",value:s.amount,onChange:t=>M("bonuses",a,"amount",t.target.value)}),e.jsx(Z,{className:"flex-1",onClick:()=>X("bonuses",a),children:e.jsx(ee,{})})]},a)),e.jsx(_,{variant:"outlined",startIcon:e.jsx(ae,{}),onClick:()=>G("bonuses",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Bonus"})]}),o&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-1 md:p-4 space-y-2 rounded-2xl",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(y,{variant:"h6",children:"Deductions"}),e.jsx(y,{variant:"h6",children:v(F)})]}),e.jsx(b,{}),l.deductions.map((s,a)=>e.jsxs("div",{className:"flex gap-2 items-start mt-4",children:[e.jsx(x,{size:"small",label:"Deduction",className:"flex-5",value:s.name,helperText:s.extraInfo??"",onChange:t=>M("deductions",a,"name",t.target.value)}),e.jsx(x,{size:"small",type:"number",className:"flex-2",label:"Amount",InputProps:{readOnly:s.inputDisabled||!1},readon:!0,value:s.amount,onChange:t=>M("deductions",a,"amount",t.target.value)}),e.jsx(Z,{className:"flex-1",onClick:()=>X("deductions",a),children:e.jsx(ee,{})})]},a)),e.jsx(_,{variant:"outlined",startIcon:e.jsx(ae,{}),onClick:()=>G("deductions",{name:"",amount:0,extraInfo:"",inputDisabled:!1}),className:"mt-2",children:"Add Deduction"})]}),o&&e.jsxs(C,{className:"shadow-md col-span-2 md:col-span-1 p-4 rounded-2xl",children:[e.jsx(y,{variant:"h6",children:"Salary Summary"}),e.jsx(b,{}),e.jsxs("div",{className:"flex flex-col gap-2 text-right mt-3",children:[e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Base Salary :"}),e.jsx("div",{className:"w-[100px] font-semibold",children:v((o==null?void 0:o.salary)||0)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Allowances :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",v(P)]})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Bonuses :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["+",v(T)]})]}),e.jsx(b,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:"Gross Salary :"}),e.jsx("div",{className:"w-[100px]",children:v(O)})]}),e.jsxs("div",{className:" flex justify-end",children:[e.jsx("div",{children:"Deductions :"}),e.jsxs("div",{className:"w-[100px] font-semibold",children:["-",v(F)," "]})]}),e.jsx(b,{}),e.jsxs("div",{className:" flex justify-end font-bold",children:[e.jsx("div",{children:" Net Salary "}),e.jsx("div",{className:"w-[100px]",children:v(me)})]}),e.jsxs("div",{className:"capitalize text-xs",children:[" In Words:- ",He(me)," "]})]})]}),o&&e.jsx("div",{className:"col-span-2",children:e.jsx(_,{variant:"contained",color:"primary",onClick:Ie,disabled:te||!k,children:te?"Saving...":"Save Payroll"})}),ne&&e.jsx("p",{className:"text-green-600 mt-2",children:ne}),oe&&e.jsx("p",{className:"text-red-600 mt-2",children:oe})]})}export{aa as default};
